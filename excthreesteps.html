<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Medical-Image-Registration-Short-Course: Demons Image Registration</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="manifest" href="site.webmanifest"><link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav IDEAS"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="IDEAS" src="assets/images/IDEAS-logo.svg"><abbr class="badge badge-light" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="background-color: #FF4955; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #000">
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
            Pre-Alpha
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/excthreesteps.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav IDEAS" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="IDEAS" src="assets/images/IDEAS-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Medical-Image-Registration-Short-Course
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Medical-Image-Registration-Short-Course
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Medical-Image-Registration-Short-Course
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 50%" class="percentage">
    50%
  </div>
  <div class="progress IDEAS">
    <div class="progress-bar IDEAS" role="progressbar" style="width: 50%" aria-valuenow="50" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/excthreesteps.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->
      
            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="itksnap.html">1. A Practical Introduction to Working with Medical Image Data</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        2. Demons Image Registration
        </span>
      
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">
            
            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="itksnap.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="index.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="itksnap.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: A Practical
        </a>
        <a class="chapter-link float-end" href="index.html" rel="next">
          Home
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Demons Image Registration</h1>
        <p>Last updated on 2024-06-25 |
        
        <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/edit/main/episodes/excthreesteps.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
        
        
        
        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How to understand and visualise three image in one pane for demons
image registration algorithm?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Understanding Demons Image Registration code for 3 images viewing
pane</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="demons-image-registration-algorithm-with-multi-pane-display">Demons Image Registration Algorithm with Multi-Pane Display<a class="anchor" aria-label="anchor" href="#demons-image-registration-algorithm-with-multi-pane-display"></a></h1>
<p>This document explains the implementation of a 2D image registration
algorithm using the Demons algorithm. The implementation includes
visualisation updates within a single window containing three panes for
easier comparison of source, target, and warped images.</p>
<div class="section level2">
<h2 id="importing-libraries">1. Importing Libraries<a class="anchor" aria-label="anchor" href="#importing-libraries"></a></h2>
<p>First, we import the necessary libraries for image processing,
transformation, and visualisation.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">from</span> skimage.transform <span class="im">import</span> rescale, resize</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> scipy.ndimage.filters <span class="im">import</span> gaussian_filter</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">from</span> utils3 <span class="im">import</span> dispImage, resampImageWithDefField, calcMSD, dispDefField</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="function-definition">2. Function Definition<a class="anchor" aria-label="anchor" href="#function-definition"></a></h2>
<p>The <code>demonsReg</code> function is defined to perform the
registration between two 2D images using the Demons algorithm. It
includes several optional parameters to control the registration
process.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">def</span> demonsReg(source, target, sigma_elastic<span class="op">=</span><span class="dv">1</span>, sigma_fluid<span class="op">=</span><span class="dv">1</span>, num_lev<span class="op">=</span><span class="dv">3</span>, use_composition<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>              use_target_grad<span class="op">=</span><span class="va">False</span>, max_it<span class="op">=</span><span class="dv">1000</span>, check_MSD<span class="op">=</span><span class="va">True</span>, disp_freq<span class="op">=</span><span class="dv">5</span>, disp_spacing<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>              scale_update_for_display<span class="op">=</span><span class="dv">10</span>, disp_method_df<span class="op">=</span><span class="st">'grid'</span>, disp_method_up<span class="op">=</span><span class="st">'arrows'</span>):</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">    Perform a registration between the 2D source image and the 2D target</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">    image using the demons algorithm. The source image is warped (resampled)</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">    into the space of the target image.</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co">    - source: 2D numpy array, the source image to be registered.</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co">    - target: 2D numpy array, the target image for registration.</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co">    - sigma_elastic: float, standard deviation for elastic regularisation.</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co">    - sigma_fluid: float, standard deviation for fluid regularisation.</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="co">    - num_lev: int, number of levels in the multi-resolution scheme.</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="co">    - use_composition: bool, whether to use composition in the update step.</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co">    - use_target_grad: bool, whether to use the target image gradient.</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="co">    - max_it: int, maximum number of iterations for the registration.</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="co">    - check_MSD: bool, whether to check Mean Squared Difference for improvements.</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="co">    - disp_freq: int, frequency of display updates during registration.</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="co">    - disp_spacing: int, spacing between grid lines or arrows in display.</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a><span class="co">    - scale_update_for_display: int, scale factor for displaying the update field.</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="co">    - disp_method_df: str, method for displaying the deformation field ('grid' or 'arrows').</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a><span class="co">    - disp_method_up: str, method for displaying the update field ('grid' or 'arrows').</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a><span class="co">    - warped_image: 2D numpy array, the source image warped into the target image space.</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a><span class="co">    - def_field: 3D numpy array, the deformation field used to warp the source image.</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="co">    """</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="preparing-images">3. Preparing Images<a class="anchor" aria-label="anchor" href="#preparing-images"></a></h2>
<p>We start by making copies of the full-resolution images.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>    <span class="co"># make copies of full resolution images</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    source_full <span class="op">=</span> source</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    target_full <span class="op">=</span> target</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="multi-resolution-scheme-and-initialisation">4. Multi-Resolution Scheme and Initialisation<a class="anchor" aria-label="anchor" href="#multi-resolution-scheme-and-initialisation"></a></h2>
<p>In this step, we initialise variables and set up the multi-resolution
scheme by looping over different resolution levels.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Loop over resolution levels</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="cf">for</span> lev <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, num_lev <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    </span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="co"># Resample images if not at the final level</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="cf">if</span> lev <span class="op">!=</span> num_lev:</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>        resamp_factor <span class="op">=</span> np.power(<span class="dv">2</span>, num_lev <span class="op">-</span> lev)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>        target <span class="op">=</span> rescale(target_full, <span class="fl">1.0</span> <span class="op">/</span> resamp_factor, mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>, anti_aliasing<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>        source <span class="op">=</span> rescale(source_full, <span class="fl">1.0</span> <span class="op">/</span> resamp_factor, mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>, anti_aliasing<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>        target <span class="op">=</span> target_full</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>        source <span class="op">=</span> source_full</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>      </span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="co"># If first level, initialise deformation and displacement fields</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    <span class="cf">if</span> lev <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>        X, Y <span class="op">=</span> np.mgrid[<span class="dv">0</span>:target.shape[<span class="dv">0</span>], <span class="dv">0</span>:target.shape[<span class="dv">1</span>]]</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>        def_field <span class="op">=</span> np.zeros((X.shape[<span class="dv">0</span>], X.shape[<span class="dv">1</span>], <span class="dv">2</span>))</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>        def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> X</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>        def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> Y</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>        disp_field_x <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>        disp_field_y <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>        <span class="co"># Otherwise, upsample displacement field from previous level</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>        disp_field_x <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> resize(disp_field_x, (target.shape[<span class="dv">0</span>], target.shape[<span class="dv">1</span>]), mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>        disp_field_y <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> resize(disp_field_y, (target.shape[<span class="dv">0</span>], target.shape[<span class="dv">1</span>]), mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>        <span class="co"># Recalculate deformation field for this level from displacement field</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>        X, Y <span class="op">=</span> np.mgrid[<span class="dv">0</span>:target.shape[<span class="dv">0</span>], <span class="dv">0</span>:target.shape[<span class="dv">1</span>]]</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>        def_field <span class="op">=</span> np.zeros((X.shape[<span class="dv">0</span>], X.shape[<span class="dv">1</span>], <span class="dv">2</span>))  <span class="co"># Clear def_field from previous level</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>        def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> X <span class="op">+</span> disp_field_x</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>        def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> Y <span class="op">+</span> disp_field_y</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>    </span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>    <span class="co"># Initialise updates</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>    update_x <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>    update_y <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>    update_def_field <span class="op">=</span> np.zeros(def_field.shape)</span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>    </span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>    <span class="co"># Calculate the transformed image at the start of this level</span></span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>    warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>    </span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>    <span class="co"># Store the current def_field and MSD value to check for improvements at the end of iteration </span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>    def_field_prev <span class="op">=</span> def_field.copy()</span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>    prev_MSD <span class="op">=</span> calcMSD(target, warped_image)</span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>    </span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>    <span class="co"># If target image gradient is being used, this can be calculated now as it will not change during the registration</span></span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a>    <span class="cf">if</span> use_target_grad:</span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>        img_grad_x, img_grad_y <span class="op">=</span> np.gradient(target)</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="display-results">4. Display Results<a class="anchor" aria-label="anchor" href="#display-results"></a></h2>
<p>In this step, we display the initial images and deformation fields
before starting the main iterative loop.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># DISPLAY RESULTS</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co"># Figure 1 - source image (does not change during registration)</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co"># Figure 2 - target image (does not change during registration)</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co"># Figure 3 - source image transformed by current deformation field</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co"># Figure 4 - deformation field</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co"># Figure 5 - update</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co"># Display source image</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>plt.figure(<span class="dv">1</span>)</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>plt.clf()</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>dispImage(source)</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="co"># Display target image</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>plt.figure(<span class="dv">2</span>)</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>plt.clf()</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>dispImage(target)</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="co"># Display source image transformed by current deformation field</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>plt.figure(<span class="dv">3</span>)</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>plt.clf()</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>dispImage(warped_image)</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>x_lims <span class="op">=</span> plt.xlim()</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>y_lims <span class="op">=</span> plt.ylim()</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a><span class="co"># Display deformation field</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>plt.figure(<span class="dv">4</span>)</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>plt.clf()</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>dispDefField(def_field, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_df)</span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>plt.xlim(x_lims)</span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>plt.ylim(y_lims)</span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a><span class="co"># Display update</span></span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>plt.figure(<span class="dv">5</span>)</span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>plt.clf()</span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>up_field_to_display <span class="op">=</span> scale_update_for_display <span class="op">*</span> np.dstack((update_x, update_y))</span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a>up_field_to_display <span class="op">+=</span> np.dstack((X, Y))</span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>dispDefField(up_field_to_display, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_up)</span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>plt.xlim(x_lims)</span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>plt.ylim(y_lims)</span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a>plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a><span class="co"># If first level, pause so user can position figures</span></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a><span class="cf">if</span> lev <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>    <span class="bu">input</span>(<span class="st">'Position the figures as desired and then push enter to run the registration'</span>)</span></code></pre>
</div>
<p>In this step, the code initialises the display of results before
starting the iterative process. This includes displaying the source
image, target image, warped image, deformation field, and update field.
The dispImage and dispDefField functions are used to visualise these
images and fields. The function pauses after the initial display to
allow the user to position the figures as desired before continuing with
the registration process.</p>
</div>
<div class="section level2">
<h2 id="main-iterative-loop">5. Main Iterative Loop<a class="anchor" aria-label="anchor" href="#main-iterative-loop"></a></h2>
<p>The main iterative loop within the <code>demonsReg</code> function
updates the deformation field based on demons forces and applies
regularisation techniques. It continues until the maximum number of
iterations is reached or until there is no improvement in the Mean
Squared Difference (MSD) between the target and warped images.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Main Iterative Loop</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="cf">for</span> it <span class="kw">in</span> <span class="bu">range</span>(max_it):</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="co"># Calculate update from demons forces</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="co"># if the warped image gradient is used (instead of the target image gradient)</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    <span class="co"># this needs to be calculated </span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> use_target_grad:</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>        [img_grad_x, img_grad_y] <span class="op">=</span> np.gradient(warped_image)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>        </span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    <span class="co"># calculate difference image</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    diff <span class="op">=</span> target <span class="op">-</span> warped_image</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>    <span class="co"># calculate denominator of demons forces</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    denom <span class="op">=</span> np.power(img_grad_x, <span class="dv">2</span>) <span class="op">+</span> np.power(img_grad_y, <span class="dv">2</span>) <span class="op">+</span> np.power(diff, <span class="dv">2</span>)</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="co"># calculate x and y components of numerator of demons forces</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    numer_x <span class="op">=</span> diff <span class="op">*</span> img_grad_x</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    numer_y <span class="op">=</span> diff <span class="op">*</span> img_grad_y</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    <span class="co"># calculate the x and y components of the update</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>    <span class="co">#denom[denom &lt; 0.01] = np.nan</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    update_x <span class="op">=</span> numer_x <span class="op">/</span> denom</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    update_y <span class="op">=</span> numer_y <span class="op">/</span> denom</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    </span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>    <span class="co"># set nan values to 0</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>    update_x[np.isnan(update_x)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>    update_y[np.isnan(update_y)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>    </span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>    <span class="co"># if fluid like regularisation used smooth the update</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>    <span class="cf">if</span> sigma_fluid <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>        update_x <span class="op">=</span> gaussian_filter(update_x, sigma_fluid, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>        update_y <span class="op">=</span> gaussian_filter(update_y, sigma_fluid, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>    </span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>    <span class="co"># update displacement field using addition (original demons) or</span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>    <span class="co"># composition (diffeomorphic demons)</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>    <span class="cf">if</span> use_composition:</span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>        <span class="co"># compose update with current transformation - this is done by</span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>        <span class="co"># transforming (resampling) the current transformation using the</span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>        <span class="co"># update. we can use the same function as used for resampling</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>        <span class="co"># images, and treat each component of the current deformation</span></span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>        <span class="co"># field as an image</span></span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>        <span class="co"># the update is a displacement field, but to resample an image</span></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>        <span class="co"># we need a deformation field, so need to calculate deformation</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>        <span class="co"># field corresponding to update.</span></span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>        update_def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> update_x <span class="op">+</span> X</span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a>        update_def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> update_y <span class="op">+</span> Y</span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a>        <span class="co"># use this to resample the current deformation field, storing</span></span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>        <span class="co"># the result in the same variable, i.e. we overwrite/update the</span></span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>        <span class="co"># current deformation field with the composed transformation</span></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>        def_field <span class="op">=</span> resampImageWithDefField(def_field, update_def_field)</span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a>        <span class="co"># calculate the displacement field from the composed deformation field</span></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>        disp_field_x <span class="op">=</span> def_field[:, :, <span class="dv">0</span>] <span class="op">-</span> X</span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a>        disp_field_y <span class="op">=</span> def_field[:, :, <span class="dv">1</span>] <span class="op">-</span> Y</span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>        <span class="co"># replace nans in disp field with 0s</span></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>        disp_field_x[np.isnan(disp_field_x)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a>        disp_field_y[np.isnan(disp_field_y)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a>        <span class="co"># add the update to the current displacement field</span></span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a>        disp_field_x <span class="op">=</span> disp_field_x <span class="op">+</span> update_x</span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>        disp_field_y <span class="op">=</span> disp_field_y <span class="op">+</span> update_y</span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a>    </span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a>    </span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a>    <span class="co"># if elastic like regularisation used smooth the displacement field</span></span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a>    <span class="cf">if</span> sigma_elastic <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a>        disp_field_x <span class="op">=</span> gaussian_filter(disp_field_x, sigma_elastic, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a>        disp_field_y <span class="op">=</span> gaussian_filter(disp_field_y, sigma_elastic, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb6-64"><a href="#cb6-64" tabindex="-1"></a>    </span>
<span id="cb6-65"><a href="#cb6-65" tabindex="-1"></a>    <span class="co"># update deformation field from disp field</span></span>
<span id="cb6-66"><a href="#cb6-66" tabindex="-1"></a>    def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> disp_field_x <span class="op">+</span> X</span>
<span id="cb6-67"><a href="#cb6-67" tabindex="-1"></a>    def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> disp_field_y <span class="op">+</span> Y</span>
<span id="cb6-68"><a href="#cb6-68" tabindex="-1"></a>            </span>
<span id="cb6-69"><a href="#cb6-69" tabindex="-1"></a>    <span class="co"># transform the image using the updated deformation field</span></span>
<span id="cb6-70"><a href="#cb6-70" tabindex="-1"></a>    warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb6-71"><a href="#cb6-71" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" tabindex="-1"></a>    <span class="co"># update images if required for this iteration</span></span>
<span id="cb6-73"><a href="#cb6-73" tabindex="-1"></a>    <span class="cf">if</span> disp_freq <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> it <span class="op">%</span> disp_freq <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-74"><a href="#cb6-74" tabindex="-1"></a>        plt.figure(<span class="dv">3</span>)</span>
<span id="cb6-75"><a href="#cb6-75" tabindex="-1"></a>        dispImage(warped_image)</span>
<span id="cb6-76"><a href="#cb6-76" tabindex="-1"></a>        plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb6-77"><a href="#cb6-77" tabindex="-1"></a>        plt.figure(<span class="dv">4</span>)</span>
<span id="cb6-78"><a href="#cb6-78" tabindex="-1"></a>        plt.clf()</span>
<span id="cb6-79"><a href="#cb6-79" tabindex="-1"></a>        dispDefField(def_field, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_df)</span>
<span id="cb6-80"><a href="#cb6-80" tabindex="-1"></a>        plt.xlim(x_lims)</span>
<span id="cb6-81"><a href="#cb6-81" tabindex="-1"></a>        plt.ylim(y_lims)</span>
<span id="cb6-82"><a href="#cb6-82" tabindex="-1"></a>        plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb6-83"><a href="#cb6-83" tabindex="-1"></a>        plt.figure(<span class="dv">5</span>)</span>
<span id="cb6-84"><a href="#cb6-84" tabindex="-1"></a>        plt.clf()</span>
<span id="cb6-85"><a href="#cb6-85" tabindex="-1"></a>        up_field_to_display <span class="op">=</span> scale_update_for_display <span class="op">*</span> np.dstack((update_x, update_y))</span>
<span id="cb6-86"><a href="#cb6-86" tabindex="-1"></a>        up_field_to_display <span class="op">+=</span> np.dstack((X, Y))</span>
<span id="cb6-87"><a href="#cb6-87" tabindex="-1"></a>        dispDefField(up_field_to_display, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_up)</span>
<span id="cb6-88"><a href="#cb6-88" tabindex="-1"></a>        plt.xlim(x_lims)</span>
<span id="cb6-89"><a href="#cb6-89" tabindex="-1"></a>        plt.ylim(y_lims)</span>
<span id="cb6-90"><a href="#cb6-90" tabindex="-1"></a>        plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb6-91"><a href="#cb6-91" tabindex="-1"></a>    </span>
<span id="cb6-92"><a href="#cb6-92" tabindex="-1"></a>    <span class="co"># calculate MSD between target and warped image</span></span>
<span id="cb6-93"><a href="#cb6-93" tabindex="-1"></a>    MSD <span class="op">=</span> calcMSD(target, warped_image)</span>
<span id="cb6-94"><a href="#cb6-94" tabindex="-1"></a></span>
<span id="cb6-95"><a href="#cb6-95" tabindex="-1"></a>    <span class="co"># display numerical results</span></span>
<span id="cb6-96"><a href="#cb6-96" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Level </span><span class="sc">{0:d}</span><span class="st">, Iteration </span><span class="sc">{1:d}</span><span class="st">: MSD = </span><span class="sc">{2:f}</span><span class="ch">\n</span><span class="st">'</span>.<span class="bu">format</span>(lev, it, MSD))</span>
<span id="cb6-97"><a href="#cb6-97" tabindex="-1"></a>    </span>
<span id="cb6-98"><a href="#cb6-98" tabindex="-1"></a>    <span class="co"># check for improvement in MSD if required</span></span>
<span id="cb6-99"><a href="#cb6-99" tabindex="-1"></a>    <span class="cf">if</span> check_MSD <span class="kw">and</span> MSD <span class="op">&gt;=</span> prev_MSD:</span>
<span id="cb6-100"><a href="#cb6-100" tabindex="-1"></a>        <span class="co"># restore previous results and finish level</span></span>
<span id="cb6-101"><a href="#cb6-101" tabindex="-1"></a>        def_field <span class="op">=</span> def_field_prev</span>
<span id="cb6-102"><a href="#cb6-102" tabindex="-1"></a>        warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb6-103"><a href="#cb6-103" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'No improvement in MSD'</span>)</span>
<span id="cb6-104"><a href="#cb6-104" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb6-105"><a href="#cb6-105" tabindex="-1"></a>    </span>
<span id="cb6-106"><a href="#cb6-106" tabindex="-1"></a>    <span class="co"># update previous values of def_field and MSD</span></span>
<span id="cb6-107"><a href="#cb6-107" tabindex="-1"></a>    def_field_prev <span class="op">=</span> def_field.copy()</span>
<span id="cb6-108"><a href="#cb6-108" tabindex="-1"></a>    prev_MSD <span class="op">=</span> MSD.copy()</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="final-results-display">6. Final Results Display<a class="anchor" aria-label="anchor" href="#final-results-display"></a></h2>
<p>After completing the iterative registration process, the final step
is to display the warped image and the deformation field. This provides
a visual representation of the registration outcome.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Final Results: Display warped image and deformation field</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>plt.figure(<span class="dv">3</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>dispImage(warped_image)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>plt.figure(<span class="dv">4</span>)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>plt.clf()</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>dispDefField(def_field, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_df)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>plt.xlim(x_lims)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>plt.ylim(y_lims)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>plt.figure(<span class="dv">5</span>)</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>plt.clf()</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>up_field_to_display <span class="op">=</span> scale_update_for_display <span class="op">*</span> np.dstack((update_x, update_y))</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>up_field_to_display <span class="op">+=</span> np.dstack((X, Y))</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>dispDefField(up_field_to_display, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_up)</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>plt.xlim(x_lims)</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>plt.ylim(y_lims)</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="return-results">7. Return Results<a class="anchor" aria-label="anchor" href="#return-results"></a></h2>
<p>The final step of the registration function is to return the warped
image and the deformation field. These outputs can be further analysed
or used for downstream processing as needed.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="cf">return</span> warped_image, def_field</span></code></pre>
</div>
</div>
</div>
<div class="section level1">
<h1 id="full-code">Full code<a class="anchor" aria-label="anchor" href="#full-code"></a></h1>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">function to perform a registration between two 2D images using the demons algorithm</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">provided for use in image registration exercises 3 for module MPHY0025 (IPMI)</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="im">from</span> skimage.transform <span class="im">import</span> rescale, resize</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="im">from</span> scipy.ndimage.filters <span class="im">import</span> gaussian_filter</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="im">from</span> utils3 <span class="im">import</span> dispImage, resampImageWithDefField, calcMSD, dispDefField</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="kw">def</span> demonsReg(source, target, sigma_elastic<span class="op">=</span><span class="dv">1</span>, sigma_fluid<span class="op">=</span><span class="dv">1</span>, num_lev<span class="op">=</span><span class="dv">3</span>, use_composition<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>              use_target_grad<span class="op">=</span><span class="va">False</span>, max_it<span class="op">=</span><span class="dv">1000</span>, check_MSD<span class="op">=</span><span class="va">True</span>, disp_freq<span class="op">=</span><span class="dv">5</span>, disp_spacing<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>              scale_update_for_display<span class="op">=</span><span class="dv">10</span>, disp_method_df<span class="op">=</span><span class="st">'grid'</span>, disp_method_up<span class="op">=</span><span class="st">'arrows'</span>):</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="co">    SYNTAX:</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="co">      demonsReg(source, target)</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a><span class="co">      demonsReg(source, target, ..., variable=value, ...)</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a><span class="co">      warped_image = demonsReg(...)</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a><span class="co">      warped_image, def_field = demonsReg(...)</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a><span class="co">    DESCRIPTION:</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="co">      Perform a registration between the 2D source image and the 2D target</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a><span class="co">    image using the demons algorithm. The source image is warped (resampled)</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="co">    into the space of the target image.</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a><span class="co">      The final warped image and deformation field can be returned as outputs</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a><span class="co">    from the function.</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a><span class="co">      </span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a><span class="co">      There are a number of optional parameters which affect the registration</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a><span class="co">    or how the results are displayed, which are explained below. These can be</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a><span class="co">    specified using variable=value inputs.</span></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a><span class="co">    The default values are given after the parameter name</span></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a><span class="co">      sigma_elastic = 1</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a><span class="co">      sigma_fluid = 1</span></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a><span class="co">          the amount of elastic and fluid regularistion to apply. these values</span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a><span class="co">          specify the standard deviation of the Gaussian used to smooth the</span></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a><span class="co">          update (fluid) or displacement field (elastic). a value of 0 means no</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a><span class="co">          smoothing is applied.</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a><span class="co">      num_lev = 3</span></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a><span class="co">          the number of levels to use in the multi-resolution scheme</span></span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a><span class="co">      use_composition = false</span></span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a><span class="co">          specifies whether the registration is performed using the classical</span></span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a><span class="co">          demons algorithm, where the updates are added to the current</span></span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a><span class="co">          transformation, or using the diffeomorphic demons algorithm, where</span></span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a><span class="co">          the updates are composed with the current transformation. Set</span></span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a><span class="co">          use_composition to true to compose the updates, or to false to add</span></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a><span class="co">          the updates.</span></span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a><span class="co">      use_target_grad = false</span></span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a><span class="co">          logical (true/false) value indicating whether the target image</span></span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a><span class="co">          gradient or warped image gradient is used when calculating the</span></span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a><span class="co">          demons forces.</span></span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a><span class="co">      max_it = 1000</span></span>
<span id="cb9-54"><a href="#cb9-54" tabindex="-1"></a><span class="co">          the maximum number of iterations to perform.</span></span>
<span id="cb9-55"><a href="#cb9-55" tabindex="-1"></a><span class="co">      check_MSD = true</span></span>
<span id="cb9-56"><a href="#cb9-56" tabindex="-1"></a><span class="co">          logical value indicating if the Mean Squared Difference (MSD)</span></span>
<span id="cb9-57"><a href="#cb9-57" tabindex="-1"></a><span class="co">          should be checked for improvement at each iteration. If true, the</span></span>
<span id="cb9-58"><a href="#cb9-58" tabindex="-1"></a><span class="co">          MSD will be evaluated at each iteration, and if there is no</span></span>
<span id="cb9-59"><a href="#cb9-59" tabindex="-1"></a><span class="co">          improvement since the previous iteration the registration will move</span></span>
<span id="cb9-60"><a href="#cb9-60" tabindex="-1"></a><span class="co">          to the next resolution level or finish if it is on the final level.</span></span>
<span id="cb9-61"><a href="#cb9-61" tabindex="-1"></a><span class="co">      disp_freq = 5</span></span>
<span id="cb9-62"><a href="#cb9-62" tabindex="-1"></a><span class="co">          the frequency with which to update the displayed images. the images</span></span>
<span id="cb9-63"><a href="#cb9-63" tabindex="-1"></a><span class="co">          will be updated every disp_freq iterations. If disp_freq is set to</span></span>
<span id="cb9-64"><a href="#cb9-64" tabindex="-1"></a><span class="co">          0 the images will not be updated during the registration</span></span>
<span id="cb9-65"><a href="#cb9-65" tabindex="-1"></a><span class="co">      disp_spacing = 2</span></span>
<span id="cb9-66"><a href="#cb9-66" tabindex="-1"></a><span class="co">          the spacing between the grid lines or arrows when displaying the</span></span>
<span id="cb9-67"><a href="#cb9-67" tabindex="-1"></a><span class="co">          deformation field and update.</span></span>
<span id="cb9-68"><a href="#cb9-68" tabindex="-1"></a><span class="co">      scale_update_for_display = 10</span></span>
<span id="cb9-69"><a href="#cb9-69" tabindex="-1"></a><span class="co">          the factor used to scale the update field for displaying</span></span>
<span id="cb9-70"><a href="#cb9-70" tabindex="-1"></a><span class="co">      disp_method_df = 'grid'</span></span>
<span id="cb9-71"><a href="#cb9-71" tabindex="-1"></a><span class="co">          the display method for the deformation field.</span></span>
<span id="cb9-72"><a href="#cb9-72" tabindex="-1"></a><span class="co">          can be 'grid' or 'arrows'</span></span>
<span id="cb9-73"><a href="#cb9-73" tabindex="-1"></a><span class="co">      disp_method_up = 'arrows'</span></span>
<span id="cb9-74"><a href="#cb9-74" tabindex="-1"></a><span class="co">          the display method for the update. can be 'grid' or 'arrows'</span></span>
<span id="cb9-75"><a href="#cb9-75" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-76"><a href="#cb9-76" tabindex="-1"></a>    </span>
<span id="cb9-77"><a href="#cb9-77" tabindex="-1"></a>    <span class="co"># make copies of full resolution images</span></span>
<span id="cb9-78"><a href="#cb9-78" tabindex="-1"></a>    source_full <span class="op">=</span> source</span>
<span id="cb9-79"><a href="#cb9-79" tabindex="-1"></a>    target_full <span class="op">=</span> target</span>
<span id="cb9-80"><a href="#cb9-80" tabindex="-1"></a>    </span>
<span id="cb9-81"><a href="#cb9-81" tabindex="-1"></a>    <span class="co"># loop over resolution levels</span></span>
<span id="cb9-82"><a href="#cb9-82" tabindex="-1"></a>    <span class="cf">for</span> lev <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, num_lev <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb9-83"><a href="#cb9-83" tabindex="-1"></a>      </span>
<span id="cb9-84"><a href="#cb9-84" tabindex="-1"></a>        <span class="co"># resample images if not final level</span></span>
<span id="cb9-85"><a href="#cb9-85" tabindex="-1"></a>        <span class="cf">if</span> lev <span class="op">!=</span> num_lev:</span>
<span id="cb9-86"><a href="#cb9-86" tabindex="-1"></a>            resamp_factor <span class="op">=</span> np.power(<span class="dv">2</span>, num_lev <span class="op">-</span> lev)</span>
<span id="cb9-87"><a href="#cb9-87" tabindex="-1"></a>            target <span class="op">=</span> rescale(target_full, <span class="fl">1.0</span> <span class="op">/</span> resamp_factor, mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>, anti_aliasing<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-88"><a href="#cb9-88" tabindex="-1"></a>            source <span class="op">=</span> rescale(source_full, <span class="fl">1.0</span> <span class="op">/</span> resamp_factor, mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>, anti_aliasing<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-89"><a href="#cb9-89" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-90"><a href="#cb9-90" tabindex="-1"></a>            target <span class="op">=</span> target_full</span>
<span id="cb9-91"><a href="#cb9-91" tabindex="-1"></a>            source <span class="op">=</span> source_full</span>
<span id="cb9-92"><a href="#cb9-92" tabindex="-1"></a>            </span>
<span id="cb9-93"><a href="#cb9-93" tabindex="-1"></a>        <span class="co"># if first level initialise def_field and disp_field</span></span>
<span id="cb9-94"><a href="#cb9-94" tabindex="-1"></a>        <span class="cf">if</span> lev <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb9-95"><a href="#cb9-95" tabindex="-1"></a>            [X, Y] <span class="op">=</span> np.mgrid[<span class="dv">0</span>:target.shape[<span class="dv">0</span>], <span class="dv">0</span>:target.shape[<span class="dv">1</span>]]</span>
<span id="cb9-96"><a href="#cb9-96" tabindex="-1"></a>            def_field <span class="op">=</span> np.zeros((X.shape[<span class="dv">0</span>], X.shape[<span class="dv">1</span>], <span class="dv">2</span>))</span>
<span id="cb9-97"><a href="#cb9-97" tabindex="-1"></a>            def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> X</span>
<span id="cb9-98"><a href="#cb9-98" tabindex="-1"></a>            def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> Y</span>
<span id="cb9-99"><a href="#cb9-99" tabindex="-1"></a>            disp_field_x <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb9-100"><a href="#cb9-100" tabindex="-1"></a>            disp_field_y <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb9-101"><a href="#cb9-101" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-102"><a href="#cb9-102" tabindex="-1"></a>            <span class="co"># otherwise upsample disp_field from previous level</span></span>
<span id="cb9-103"><a href="#cb9-103" tabindex="-1"></a>            disp_field_x <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> resize(disp_field_x, (target.shape[<span class="dv">0</span>], target.shape[<span class="dv">1</span>]), mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb9-104"><a href="#cb9-104" tabindex="-1"></a>            disp_field_y <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> resize(disp_field_y, (target.shape[<span class="dv">0</span>], target.shape[<span class="dv">1</span>]), mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb9-105"><a href="#cb9-105" tabindex="-1"></a>            <span class="co"># recalculate def_field for this level from disp_field</span></span>
<span id="cb9-106"><a href="#cb9-106" tabindex="-1"></a>            X, Y <span class="op">=</span> np.mgrid[<span class="dv">0</span>:target.shape[<span class="dv">0</span>], <span class="dv">0</span>:target.shape[<span class="dv">1</span>]]</span>
<span id="cb9-107"><a href="#cb9-107" tabindex="-1"></a>            def_field <span class="op">=</span> np.zeros((X.shape[<span class="dv">0</span>], X.shape[<span class="dv">1</span>], <span class="dv">2</span>))  <span class="co"># clear def_field from previous level</span></span>
<span id="cb9-108"><a href="#cb9-108" tabindex="-1"></a>            def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> X <span class="op">+</span> disp_field_x</span>
<span id="cb9-109"><a href="#cb9-109" tabindex="-1"></a>            def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> Y <span class="op">+</span> disp_field_y</span>
<span id="cb9-110"><a href="#cb9-110" tabindex="-1"></a>        </span>
<span id="cb9-111"><a href="#cb9-111" tabindex="-1"></a>        <span class="co"># initialise updates</span></span>
<span id="cb9-112"><a href="#cb9-112" tabindex="-1"></a>        update_x <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb9-113"><a href="#cb9-113" tabindex="-1"></a>        update_y <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb9-114"><a href="#cb9-114" tabindex="-1"></a>        update_def_field <span class="op">=</span> np.zeros(def_field.shape)</span>
<span id="cb9-115"><a href="#cb9-115" tabindex="-1"></a>        </span>
<span id="cb9-116"><a href="#cb9-116" tabindex="-1"></a>        <span class="co"># calculate the transformed image at the start of this level</span></span>
<span id="cb9-117"><a href="#cb9-117" tabindex="-1"></a>        warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb9-118"><a href="#cb9-118" tabindex="-1"></a>        </span>
<span id="cb9-119"><a href="#cb9-119" tabindex="-1"></a>        <span class="co"># store the current def_field and MSD value to check for improvements at </span></span>
<span id="cb9-120"><a href="#cb9-120" tabindex="-1"></a>        <span class="co"># end of iteration </span></span>
<span id="cb9-121"><a href="#cb9-121" tabindex="-1"></a>        def_field_prev <span class="op">=</span> def_field.copy()</span>
<span id="cb9-122"><a href="#cb9-122" tabindex="-1"></a>        prev_MSD <span class="op">=</span> calcMSD(target, warped_image)</span>
<span id="cb9-123"><a href="#cb9-123" tabindex="-1"></a>          </span>
<span id="cb9-124"><a href="#cb9-124" tabindex="-1"></a>        <span class="co"># if target image gradient is being used this can be calculated now as it will</span></span>
<span id="cb9-125"><a href="#cb9-125" tabindex="-1"></a>        <span class="co"># not change during the registration</span></span>
<span id="cb9-126"><a href="#cb9-126" tabindex="-1"></a>        <span class="cf">if</span> use_target_grad:</span>
<span id="cb9-127"><a href="#cb9-127" tabindex="-1"></a>            [img_grad_x, img_grad_y] <span class="op">=</span> np.gradient(target)</span>
<span id="cb9-128"><a href="#cb9-128" tabindex="-1"></a>              </span>
<span id="cb9-129"><a href="#cb9-129" tabindex="-1"></a>        <span class="co"># DISPLAY RESULTS</span></span>
<span id="cb9-130"><a href="#cb9-130" tabindex="-1"></a>        <span class="co"># single window with three panes for source, target, and warped image</span></span>
<span id="cb9-131"><a href="#cb9-131" tabindex="-1"></a>        fig, (ax1, ax2, ax3) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb9-132"><a href="#cb9-132" tabindex="-1"></a>        ax1.set_title(<span class="st">'Source Image'</span>)</span>
<span id="cb9-133"><a href="#cb9-133" tabindex="-1"></a>        ax2.set_title(<span class="st">'Target Image'</span>)</span>
<span id="cb9-134"><a href="#cb9-134" tabindex="-1"></a>        ax3.set_title(<span class="st">'Warped Image'</span>)</span>
<span id="cb9-135"><a href="#cb9-135" tabindex="-1"></a></span>
<span id="cb9-136"><a href="#cb9-136" tabindex="-1"></a>        ax1.imshow(source, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-137"><a href="#cb9-137" tabindex="-1"></a>        ax2.imshow(target, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-138"><a href="#cb9-138" tabindex="-1"></a>        ax3.imshow(warped_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-139"><a href="#cb9-139" tabindex="-1"></a></span>
<span id="cb9-140"><a href="#cb9-140" tabindex="-1"></a>        plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb9-141"><a href="#cb9-141" tabindex="-1"></a>        </span>
<span id="cb9-142"><a href="#cb9-142" tabindex="-1"></a>        <span class="co"># if first level pause so user can position figure</span></span>
<span id="cb9-143"><a href="#cb9-143" tabindex="-1"></a>        <span class="cf">if</span> lev <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb9-144"><a href="#cb9-144" tabindex="-1"></a>            <span class="bu">input</span>(<span class="st">'position the figures as desired and then push enter to run the registration'</span>)</span>
<span id="cb9-145"><a href="#cb9-145" tabindex="-1"></a>        </span>
<span id="cb9-146"><a href="#cb9-146" tabindex="-1"></a>        <span class="co"># main iterative loop - repeat until max number of iterations reached</span></span>
<span id="cb9-147"><a href="#cb9-147" tabindex="-1"></a>        <span class="cf">for</span> it <span class="kw">in</span> <span class="bu">range</span>(max_it):</span>
<span id="cb9-148"><a href="#cb9-148" tabindex="-1"></a>          </span>
<span id="cb9-149"><a href="#cb9-149" tabindex="-1"></a>            <span class="co"># calculate update from demons forces</span></span>
<span id="cb9-150"><a href="#cb9-150" tabindex="-1"></a>            <span class="co">#</span></span>
<span id="cb9-151"><a href="#cb9-151" tabindex="-1"></a>            <span class="co"># if the warped image gradient is used (instead of the target image gradient)</span></span>
<span id="cb9-152"><a href="#cb9-152" tabindex="-1"></a>            <span class="co"># this needs to be calculated </span></span>
<span id="cb9-153"><a href="#cb9-153" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> use_target_grad:</span>
<span id="cb9-154"><a href="#cb9-154" tabindex="-1"></a>                [img_grad_x, img_grad_y] <span class="op">=</span> np.gradient(warped_image)</span>
<span id="cb9-155"><a href="#cb9-155" tabindex="-1"></a>            </span>
<span id="cb9-156"><a href="#cb9-156" tabindex="-1"></a>            <span class="co"># calculate difference image</span></span>
<span id="cb9-157"><a href="#cb9-157" tabindex="-1"></a>            diff <span class="op">=</span> target <span class="op">-</span> warped_image</span>
<span id="cb9-158"><a href="#cb9-158" tabindex="-1"></a>            <span class="co"># calculate denominator of demons forces</span></span>
<span id="cb9-159"><a href="#cb9-159" tabindex="-1"></a>            denom <span class="op">=</span> np.power(img_grad_x, <span class="dv">2</span>) <span class="op">+</span> np.power(img_grad_y, <span class="dv">2</span>) <span class="op">+</span> np.power(diff, <span class="dv">2</span>)</span>
<span id="cb9-160"><a href="#cb9-160" tabindex="-1"></a>            <span class="co"># calculate x and y components of numerator of demons forces</span></span>
<span id="cb9-161"><a href="#cb9-161" tabindex="-1"></a>            numer_x <span class="op">=</span> diff <span class="op">*</span> img_grad_x</span>
<span id="cb9-162"><a href="#cb9-162" tabindex="-1"></a>            numer_y <span class="op">=</span> diff <span class="op">*</span> img_grad_y</span>
<span id="cb9-163"><a href="#cb9-163" tabindex="-1"></a>            <span class="co"># calculate the x and y components of the update</span></span>
<span id="cb9-164"><a href="#cb9-164" tabindex="-1"></a>            update_x <span class="op">=</span> numer_x <span class="op">/</span> denom</span>
<span id="cb9-165"><a href="#cb9-165" tabindex="-1"></a>            update_y <span class="op">=</span> numer_y <span class="op">/</span> denom</span>
<span id="cb9-166"><a href="#cb9-166" tabindex="-1"></a>            </span>
<span id="cb9-167"><a href="#cb9-167" tabindex="-1"></a>            <span class="co"># set nan values to 0</span></span>
<span id="cb9-168"><a href="#cb9-168" tabindex="-1"></a>            update_x[np.isnan(update_x)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-169"><a href="#cb9-169" tabindex="-1"></a>            update_y[np.isnan(update_y)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-170"><a href="#cb9-170" tabindex="-1"></a>              </span>
<span id="cb9-171"><a href="#cb9-171" tabindex="-1"></a>            <span class="co"># if fluid like regularisation used smooth the update</span></span>
<span id="cb9-172"><a href="#cb9-172" tabindex="-1"></a>            <span class="cf">if</span> sigma_fluid <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-173"><a href="#cb9-173" tabindex="-1"></a>                update_x <span class="op">=</span> gaussian_filter(update_x, sigma_fluid, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb9-174"><a href="#cb9-174" tabindex="-1"></a>                update_y <span class="op">=</span> gaussian_filter(update_y, sigma_fluid, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb9-175"><a href="#cb9-175" tabindex="-1"></a>            </span>
<span id="cb9-176"><a href="#cb9-176" tabindex="-1"></a>            <span class="co"># update displacement field using addition (original demons) or</span></span>
<span id="cb9-177"><a href="#cb9-177" tabindex="-1"></a>            <span class="co"># composition (diffeomorphic demons)</span></span>
<span id="cb9-178"><a href="#cb9-178" tabindex="-1"></a>            <span class="cf">if</span> use_composition:</span>
<span id="cb9-179"><a href="#cb9-179" tabindex="-1"></a>                <span class="co"># compose update with current transformation - this is done by</span></span>
<span id="cb9-180"><a href="#cb9-180" tabindex="-1"></a>                <span class="co"># transforming (resampling) the current transformation using the</span></span>
<span id="cb9-181"><a href="#cb9-181" tabindex="-1"></a>                <span class="co"># update. we can use the same function as used for resampling</span></span>
<span id="cb9-182"><a href="#cb9-182" tabindex="-1"></a>                <span class="co"># images, and treat each component of the current deformation</span></span>
<span id="cb9-183"><a href="#cb9-183" tabindex="-1"></a>                <span class="co"># field as an image</span></span>
<span id="cb9-184"><a href="#cb9-184" tabindex="-1"></a>                <span class="co"># the update is a displacement field, but to resample an image</span></span>
<span id="cb9-185"><a href="#cb9-185" tabindex="-1"></a>                <span class="co"># we need a deformation field, so need to calculate deformation</span></span>
<span id="cb9-186"><a href="#cb9-186" tabindex="-1"></a>                <span class="co"># field corresponding to update.</span></span>
<span id="cb9-187"><a href="#cb9-187" tabindex="-1"></a>                update_def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> update_x <span class="op">+</span> X</span>
<span id="cb9-188"><a href="#cb9-188" tabindex="-1"></a>                update_def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> update_y <span class="op">+</span> Y</span>
<span id="cb9-189"><a href="#cb9-189" tabindex="-1"></a>                <span class="co"># use this to resample the current deformation field, storing</span></span>
<span id="cb9-190"><a href="#cb9-190" tabindex="-1"></a>                <span class="co"># the result in the same variable, i.e. we overwrite/update the</span></span>
<span id="cb9-191"><a href="#cb9-191" tabindex="-1"></a>                <span class="co"># current deformation field with the composed transformation</span></span>
<span id="cb9-192"><a href="#cb9-192" tabindex="-1"></a>                def_field <span class="op">=</span> resampImageWithDefField(def_field, update_def_field)</span>
<span id="cb9-193"><a href="#cb9-193" tabindex="-1"></a>                <span class="co"># calculate the displacement field from the composed deformation field</span></span>
<span id="cb9-194"><a href="#cb9-194" tabindex="-1"></a>                disp_field_x <span class="op">=</span> def_field[:, :, <span class="dv">0</span>] <span class="op">-</span> X</span>
<span id="cb9-195"><a href="#cb9-195" tabindex="-1"></a>                disp_field_y <span class="op">=</span> def_field[:, :, <span class="dv">1</span>] <span class="op">-</span> Y</span>
<span id="cb9-196"><a href="#cb9-196" tabindex="-1"></a>                <span class="co"># replace nans in disp field with 0s</span></span>
<span id="cb9-197"><a href="#cb9-197" tabindex="-1"></a>                disp_field_x[np.isnan(disp_field_x)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-198"><a href="#cb9-198" tabindex="-1"></a>                disp_field_y[np.isnan(disp_field_y)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-199"><a href="#cb9-199" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb9-200"><a href="#cb9-200" tabindex="-1"></a>                <span class="co"># add the update to the current displacement field</span></span>
<span id="cb9-201"><a href="#cb9-201" tabindex="-1"></a>                disp_field_x <span class="op">=</span> disp_field_x <span class="op">+</span> update_x</span>
<span id="cb9-202"><a href="#cb9-202" tabindex="-1"></a>                disp_field_y <span class="op">=</span> disp_field_y <span class="op">+</span> update_y</span>
<span id="cb9-203"><a href="#cb9-203" tabindex="-1"></a>            </span>
<span id="cb9-204"><a href="#cb9-204" tabindex="-1"></a>            <span class="co"># if elastic like regularisation used smooth the displacement field</span></span>
<span id="cb9-205"><a href="#cb9-205" tabindex="-1"></a>            <span class="cf">if</span> sigma_elastic <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-206"><a href="#cb9-206" tabindex="-1"></a>                disp_field_x <span class="op">=</span> gaussian_filter(disp_field_x, sigma_elastic, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb9-207"><a href="#cb9-207" tabindex="-1"></a>                disp_field_y <span class="op">=</span> gaussian_filter(disp_field_y, sigma_elastic, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb9-208"><a href="#cb9-208" tabindex="-1"></a>            </span>
<span id="cb9-209"><a href="#cb9-209" tabindex="-1"></a>            <span class="co"># update deformation field from disp field</span></span>
<span id="cb9-210"><a href="#cb9-210" tabindex="-1"></a>            def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> disp_field_x <span class="op">+</span> X</span>
<span id="cb9-211"><a href="#cb9-211" tabindex="-1"></a>            def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> disp_field_y <span class="op">+</span> Y</span>
<span id="cb9-212"><a href="#cb9-212" tabindex="-1"></a>              </span>
<span id="cb9-213"><a href="#cb9-213" tabindex="-1"></a>            <span class="co"># transform the image using the updated deformation field</span></span>
<span id="cb9-214"><a href="#cb9-214" tabindex="-1"></a>            warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb9-215"><a href="#cb9-215" tabindex="-1"></a></span>
<span id="cb9-216"><a href="#cb9-216" tabindex="-1"></a>            <span class="co"># update images if required for this iteration</span></span>
<span id="cb9-217"><a href="#cb9-217" tabindex="-1"></a>            <span class="cf">if</span> disp_freq <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> it <span class="op">%</span> disp_freq <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-218"><a href="#cb9-218" tabindex="-1"></a>                ax1.clear()</span>
<span id="cb9-219"><a href="#cb9-219" tabindex="-1"></a>                ax2.clear()</span>
<span id="cb9-220"><a href="#cb9-220" tabindex="-1"></a>                ax3.clear()</span>
<span id="cb9-221"><a href="#cb9-221" tabindex="-1"></a>                </span>
<span id="cb9-222"><a href="#cb9-222" tabindex="-1"></a>                ax1.set_title(<span class="st">'Source Image'</span>)</span>
<span id="cb9-223"><a href="#cb9-223" tabindex="-1"></a>                ax2.set_title(<span class="st">'Target Image'</span>)</span>
<span id="cb9-224"><a href="#cb9-224" tabindex="-1"></a>                ax3.set_title(<span class="st">'Warped Image'</span>)</span>
<span id="cb9-225"><a href="#cb9-225" tabindex="-1"></a></span>
<span id="cb9-226"><a href="#cb9-226" tabindex="-1"></a>                ax1.imshow(source, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-227"><a href="#cb9-227" tabindex="-1"></a>                ax2.imshow(target, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-228"><a href="#cb9-228" tabindex="-1"></a>                ax3.imshow(warped_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-229"><a href="#cb9-229" tabindex="-1"></a></span>
<span id="cb9-230"><a href="#cb9-230" tabindex="-1"></a>                plt.pause(<span class="fl">0.05</span>)</span>
<span id="cb9-231"><a href="#cb9-231" tabindex="-1"></a>              </span>
<span id="cb9-232"><a href="#cb9-232" tabindex="-1"></a>            <span class="co"># calculate MSD between target and warped image</span></span>
<span id="cb9-233"><a href="#cb9-233" tabindex="-1"></a>            MSD <span class="op">=</span> calcMSD(target, warped_image)</span>
<span id="cb9-234"><a href="#cb9-234" tabindex="-1"></a></span>
<span id="cb9-235"><a href="#cb9-235" tabindex="-1"></a>            <span class="co"># display numerical results</span></span>
<span id="cb9-236"><a href="#cb9-236" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'Level </span><span class="sc">{0:d}</span><span class="st">, Iteration </span><span class="sc">{1:d}</span><span class="st">: MSD = </span><span class="sc">{2:f}</span><span class="ch">\n</span><span class="st">'</span>.<span class="bu">format</span>(lev, it, MSD))</span>
<span id="cb9-237"><a href="#cb9-237" tabindex="-1"></a>            </span>
<span id="cb9-238"><a href="#cb9-238" tabindex="-1"></a>            <span class="co"># check for improvement in MSD if required</span></span>
<span id="cb9-239"><a href="#cb9-239" tabindex="-1"></a>            <span class="cf">if</span> check_MSD <span class="kw">and</span> MSD <span class="op">&gt;=</span> prev_MSD:</span>
<span id="cb9-240"><a href="#cb9-240" tabindex="-1"></a>                <span class="co"># restore previous results and finish level</span></span>
<span id="cb9-241"><a href="#cb9-241" tabindex="-1"></a>                def_field <span class="op">=</span> def_field_prev</span>
<span id="cb9-242"><a href="#cb9-242" tabindex="-1"></a>                warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb9-243"><a href="#cb9-243" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">'No improvement in MSD'</span>)</span>
<span id="cb9-244"><a href="#cb9-244" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb9-245"><a href="#cb9-245" tabindex="-1"></a>            </span>
<span id="cb9-246"><a href="#cb9-246" tabindex="-1"></a>            <span class="co"># update previous values of def_field and MSD</span></span>
<span id="cb9-247"><a href="#cb9-247" tabindex="-1"></a>            def_field_prev <span class="op">=</span> def_field.copy()</span>
<span id="cb9-248"><a href="#cb9-248" tabindex="-1"></a>            prev_MSD <span class="op">=</span> MSD.copy()</span>
<span id="cb9-249"><a href="#cb9-249" tabindex="-1"></a>      </span>
<span id="cb9-250"><a href="#cb9-250" tabindex="-1"></a>    <span class="co"># display the final results</span></span>
<span id="cb9-251"><a href="#cb9-251" tabindex="-1"></a>    ax1.clear()</span>
<span id="cb9-252"><a href="#cb9-252" tabindex="-1"></a>    ax2.clear()</span>
<span id="cb9-253"><a href="#cb9-253" tabindex="-1"></a>    ax3.clear()</span>
<span id="cb9-254"><a href="#cb9-254" tabindex="-1"></a>    </span>
<span id="cb9-255"><a href="#cb9-255" tabindex="-1"></a>    ax1.set_title(<span class="st">'Source Image'</span>)</span>
<span id="cb9-256"><a href="#cb9-256" tabindex="-1"></a>    ax2.set_title(<span class="st">'Target Image'</span>)</span>
<span id="cb9-257"><a href="#cb9-257" tabindex="-1"></a>    ax3.set_title(<span class="st">'Warped Image'</span>)</span>
<span id="cb9-258"><a href="#cb9-258" tabindex="-1"></a></span>
<span id="cb9-259"><a href="#cb9-259" tabindex="-1"></a>    ax1.imshow(source, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-260"><a href="#cb9-260" tabindex="-1"></a>    ax2.imshow(target, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-261"><a href="#cb9-261" tabindex="-1"></a>    ax3.imshow(warped_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-262"><a href="#cb9-262" tabindex="-1"></a></span>
<span id="cb9-263"><a href="#cb9-263" tabindex="-1"></a>    plt.show()</span>
<span id="cb9-264"><a href="#cb9-264" tabindex="-1"></a>    </span>
<span id="cb9-265"><a href="#cb9-265" tabindex="-1"></a>    <span class="co"># return the transformed image and the deformation field</span></span>
<span id="cb9-266"><a href="#cb9-266" tabindex="-1"></a>    <span class="cf">return</span> warped_image, def_field</span></code></pre>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>



      </div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="itksnap.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="index.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="itksnap.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: A Practical
        </a>
        <a class="chapter-link float-end" href="index.html" rel="next">
          Home
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/edit/main/episodes/excthreesteps.Rmd" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/" class="external-link">Source</a></p>
				<p><a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/HealthBioscienceIDEAS/sandpaper/tree/IDEAS" class="external-link">sandpaper (0.16.5)</a>, <a href="https://github.com/carpentries/pegboard/tree/ad2542f7f7b9c3f90cc871b355ff81ec14a09ca9" class="external-link">pegboard (0.7.6)</a>, and <a href="https://github.com/HealthBioscienceIDEAS/varnish/tree/IDEAS" class="external-link">varnish (1.0.3.9000)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://HealthBioscienceIDEAS.github.io/Medical-Image-Registration-Short-Course/excthreesteps.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Demons Image Registration",
  "creativeWorkStatus": "active",
  "url": "https://HealthBioscienceIDEAS.github.io/Medical-Image-Registration-Short-Course/excthreesteps.html",
  "identifier": "https://HealthBioscienceIDEAS.github.io/Medical-Image-Registration-Short-Course/excthreesteps.html",
  "dateCreated": "2024-05-13",
  "dateModified": "2024-06-25",
  "datePublished": "2024-06-25"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

