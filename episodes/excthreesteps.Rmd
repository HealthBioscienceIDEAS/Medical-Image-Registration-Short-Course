---
title: 'exercise3stepbystep'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How to understand and visualise volumetric medical data in ITK-SNAP?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Medical imaging data in DICOM and nifti formats
- Getting started with ITK-SNAP
- Viewing data
- Converting data
- Modifyiing data

::::::::::::::::::::::::::::::::::::::::::::::::

# Demons Image Registration Algorithm with Multi-Pane Display

This document explains the implementation of a 2D image registration algorithm using the Demons algorithm. The implementation includes visualisation updates within a single window containing three panes for easier comparison of source, target, and warped images.

## 1. Importing Libraries

First, we import the necessary libraries for image processing, transformation, and visualisation.

```python
import matplotlib.pyplot as plt
import numpy as np
from skimage.transform import rescale, resize
from scipy.ndimage.filters import gaussian_filter
from utils3 import dispImage, resampImageWithDefField, calcMSD, dispDefField
```


## 2. Function Definition

The `demonsReg` function is defined to perform the registration between two 2D images using the Demons algorithm. It includes several optional parameters to control the registration process.

```python
def demonsReg(source, target, sigma_elastic=1, sigma_fluid=1, num_lev=3, use_composition=False,
              use_target_grad=False, max_it=1000, check_MSD=True, disp_freq=5, disp_spacing=2, 
              scale_update_for_display=10, disp_method_df='grid', disp_method_up='arrows'):
    """
    Perform a registration between the 2D source image and the 2D target
    image using the demons algorithm. The source image is warped (resampled)
    into the space of the target image.
    
    Parameters:
    - source: 2D numpy array, the source image to be registered.
    - target: 2D numpy array, the target image for registration.
    - sigma_elastic: float, standard deviation for elastic regularization.
    - sigma_fluid: float, standard deviation for fluid regularization.
    - num_lev: int, number of levels in the multi-resolution scheme.
    - use_composition: bool, whether to use composition in the update step.
    - use_target_grad: bool, whether to use the target image gradient.
    - max_it: int, maximum number of iterations for the registration.
    - check_MSD: bool, whether to check Mean Squared Difference for improvements.
    - disp_freq: int, frequency of display updates during registration.
    - disp_spacing: int, spacing between grid lines or arrows in display.
    - scale_update_for_display: int, scale factor for displaying the update field.
    - disp_method_df: str, method for displaying the deformation field ('grid' or 'arrows').
    - disp_method_up: str, method for displaying the update field ('grid' or 'arrows').
    
    Returns:
    - warped_image: 2D numpy array, the source image warped into the target image space.
    - def_field: 3D numpy array, the deformation field used to warp the source image.
    """
    # make copies of full resolution images
    source_full = source
    target_full = target
    
    # rest of the function...
```
