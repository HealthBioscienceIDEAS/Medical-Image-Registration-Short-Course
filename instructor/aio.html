<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Medical-Image-Registration-Short-Course: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="manifest" href="../site.webmanifest">
<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav IDEAS"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="IDEAS" src="../assets/images/IDEAS-logo.svg"><abbr class="badge badge-light" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="background-color: #FF4955; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #000">
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
            Pre-Alpha
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>

      </div>
    </div>
    <div class="selector-container">


      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Learner View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav IDEAS" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="IDEAS" src="../assets/images/IDEAS-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Medical-Image-Registration-Short-Course
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Medical-Image-Registration-Short-Course
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<hr>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Medical-Image-Registration-Short-Course
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress IDEAS">
    <div class="progress-bar IDEAS" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Learner View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="itksnap.html">1. A Practical Introduction to Working with Medical Image Data</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="excthreesteps.html">2. Demons Image Registration</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-itksnap"><p>Content from <a href="itksnap.html">A Practical Introduction to Working with Medical Image Data</a></p>
<hr>
<p>Last updated on 2024-09-04 |

        <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/edit/main/episodes/itksnap.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 12 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we visualize volumetric data?</li>
<li>How do locations in an image get mapped to real-world
coordinates?</li>
<li>How can we register different types of images together using
ITK-SNAP?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Describe the structure of medical imaging data and popular formats
(DICOM and NifTi)</li>
<li>Discover and display medical imaging data in ITK-SNAP</li>
<li>Demonstrate how to convert between different medical image
formats</li>
<li>Inspecting the NifTi header with <code>nibabel</code>
</li>
<li>Manipulate image data (cropping images) with <code>nibabel</code>
and learn how it is displayed on screen with ITK-SNAP</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="medical-imaging-data">Medical Imaging Data<a class="anchor" aria-label="anchor" href="#medical-imaging-data"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="the-cancer-imaging-archive-tcia">The Cancer Imaging Archive (TCIA)<a class="anchor" aria-label="anchor" href="#the-cancer-imaging-archive-tcia"></a>
</h3>
<p>In these exercises we will be working with real-world medical imaging
data from the Cancer Imaging Archive <a href="https://www.cancerimagingarchive.net/collection/ct-vs-pet-ventilation-imaging/" class="external-link">(TCIA)</a>.
TCIA is a resource of public datasets hosts a large archive of medical
images of cancer accessible for public download.<br>
We are using CT Ventilation as a Functional Imaging Modality for Lung
Cancer Radiotherapy (also known as
<code>CT-vs-PET-Ventilation-Imaging dataset</code>) from TCIA. The
CT-vs-PET-Ventilation-Imaging collection is distributed under the
Creative Commons Attribution 4.0 International License (<a href="https://creativecommons.org/licenses/by/4.0/" class="external-link uri">https://creativecommons.org/licenses/by/4.0/</a>). The
<code>CT-vs-PET-Ventilation-Imaging</code> dataset contains 20 lung
cancer patients underwent exhale/inhale breath hold CT (BHCT),
free-breathing four-dimensional CT (4DCT) and Galligas PET ventilation
scans in a single session on a combined 4DPET/CT scanner.</p>
<p>We recommend using the BHCT scans for participants
<code>CT-PET-VI-02</code> and <code>CT-PET-VI-03</code> showing very
little motion between inhale and exhale (for PET scan and accompanying
CT scan), and BHCT scans for participants <code>CT-PET-VI-05</code> and
<code>CT-PET-VI-07</code> (the inhale and exhale CT scans), where 05 has
a different number of slices between the inhale and exhale.</p>
<p>Data paths contain: (A) <code>inhale_BH_CT</code> and
<code>exhale_BH_CT</code> contain CT scans acquired during an inhalation
breath hold and exhalation breath hold respectively, (B)
<code>PET</code> contains a PET scan that measures the local lung
function, and (C) <code>CT_for_PET</code> contains a CT scan acquired at
the same time as the PET scan for attenuation correction of the PET scan
and to provide anatomical reference for the PET data.</p>
<ul>
<li>CT-PET-VI-02</li>
</ul>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">├──</span> CT-PET-VI-02</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">│  </span> ├── CT_for_PET</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="ex">│  </span> ├── exhale_BH_CT</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="ex">│  </span> ├── inhale_BH_CT</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="ex">│  </span> └── PET</span></code></pre>
</div>
<ul>
<li>CT-PET-VI-03</li>
</ul>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">/CT-PET-VI-03$</span> tree <span class="at">-d</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="ex">├──</span> CT-PET-VI-03</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="ex">│  </span> ├── CT_for_PET</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="ex">│  </span> └── PET</span></code></pre>
</div>
<ul>
<li>CT-PET-VI-05</li>
</ul>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">CT-PET-VI-05$</span> tree <span class="at">-d</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="ex">├──</span> CT-PET-VI-05</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="ex">│  </span> ├── CT_for_PET</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="ex">│  </span> ├── exhale_BH_CT</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="ex">│  </span> ├── inhale_BH_CT</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="ex">│  </span> └── PET</span></code></pre>
</div>
<ul>
<li>CT-PET-VI-07</li>
</ul>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">/CT-PET-VI-07$</span> tree <span class="at">-d</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="ex">└──</span> CT-PET-VI-07</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="ex">├──</span> exhale_BH_CT</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="ex">├──</span> inhale_BH_CT</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="ex">└──</span> PET</span></code></pre>
</div>
<p>For example, datasets in ITK-SNAP are illustrated in the following
figures. <img src="../fig/CT-PET-VI-02.svg" alt="Figure. CT-PET-VI-02 dataset" class="figure"></p>
<p>Refer to <a href="https://healthbioscienceideas.github.io/Medical-Image-Registration-Short-Course/#data-sets" class="external-link"><code>Summary and Setup</code></a>
section for further details on CT-vs-PET-Ventilation-Imaging
dataset.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Data sharing ethics and policies
  </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>Data may require extensive cleaning and pre-processing before it is
suitable to be used.</li>
<li>When using open datasets that contain images of humans, such as
those from TCIA, for your own research, you will still need to get
ethical approval as you do for any non-open datasets you use). This can
usually be obtained from the local ethics committee (both Medical
Physics and Computer Science have their own local ethics committee) or
from UCL central ethics if your department does not have one.</li>
<li>Although there are many formats that medical imaging data can come
in, we are going to focus on DICOM and NifTi as they are two of the most
common formats. Most data that comes from a hospital will be in DICOM
format, whereas NifTi is a very popular format in the medical image
analysis community.</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="dicom-format">DICOM format<a class="anchor" aria-label="anchor" href="#dicom-format"></a>
</h3>
<p>Digital Imaging and Communications in Medicine (DICOM) is a technical
standard for the digital storage and transmission of medical images and
related information. While DICOM images typically have a separate file
for every slice, more modern DICOM images can come with all slices in a
single file.</p>
<p>If you look at the data <code>CT-PET-VI-02/CT_for_PET</code> you will
see there are 175 individual files corresponding to 175 slices in the
volume. In addition to the image data for each slice, each file contains
a header which can contain an extensive amount of extra information
relating to the scan and subject.</p>
<p>In a clinical setting this will include patient identifiable
information such as their name, address, and other relevant details.
Such information should be removed before the data is transferred from
the clinical network for use in research. If you ever discover patient
identifiable information in the header of data you are using you should
immediately alert your supervisor, manager or collaborator</p>
<p>The majority of the information in the DICOM header is not directly
useful for typical image processing and analysis tasks. Furthermore,
there are complicated ‘links’ (provided by unique identifiers, UIDs)
between the DICOM headers of different files belonging to the same scan
or subject. Together with DICOM routinely storing each slice as a
separate files, it makes processing an entire imaging volume stored as
DICOM format rather cumbersome, and the extra housekeeping required
could lead to a greater chance of an error being made. Therefore, a
common first step of any image processing pipeline is to convert the
DICOM image to a more suitable format such as <code>NifTi</code>.
Generally, most conversions go from DICOM to NIfTI. There are scenarios
when you might want to convert from NIfTI <strong>back</strong> to
DICOM, for example, if you need to import them into a clinical system
that only works with DICOM.</p>
<div id="accordionSpoiler2" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler2" aria-expanded="false" aria-controls="collapseSpoiler2">
  <h3 class="accordion-header" id="headingSpoiler2">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Warning on converting images back to DICOM
  </h3>
</button>
<div id="collapseSpoiler2" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler2" aria-labelledby="headingSpoiler2">
<div class="accordion-body">
<p>Converting images back to DICOM such that they are correctly
interpreted by a clinical system can be very tricky and requires a good
understanding of the DICOM standard. More information on the DICOM
standard can be found here: <a href="https://www.dicomstandard.org" class="external-link uri">https://www.dicomstandard.org</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="nifti-format">NifTi format<a class="anchor" aria-label="anchor" href="#nifti-format"></a>
</h3>
<p>The Neuroimaging Informatics Technology Initiative (NIfTI) image
format are usually stored as a single file containing the imaging data
and header information. While the NifTI file format was originally
developed by the neuroimaging community it is not specific to
neuroimaging and is now widely used for many different medical imaging
applications outside of the brain. During these exercises you will learn
about some of the key information stored in the NifTi header.</p>
<p>NifTI files can also store the header and image data in separate
files but this is not very common. For more information, please see
Anderson Winkler’s blog on the <a href="https://brainder.org/2012/09/23/the-nifti-file-format/" class="external-link">NIfTI-1</a>
and<a href="https://brainder.org/2015/04/03/the-nifti-2-file-format/" class="external-link">NIfTI-2</a>
formats.</p>
</div>
</section><section><h2 class="section-heading" id="visualisation-of-volumetric-data-with-itk-snap">Visualisation of volumetric data with ITK-SNAP<a class="anchor" aria-label="anchor" href="#visualisation-of-volumetric-data-with-itk-snap"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="getting-started-with-itk-snap">Getting Started with ITK-SNAP<a class="anchor" aria-label="anchor" href="#getting-started-with-itk-snap"></a>
</h3>
<div class="section level4">
<h4 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h4>
<p>ITK-SNAP started in 1999 with SNAP (SNake Automatic Partitioning) and
developed by Paul Yushkevich with the guidance of Guido Gerig. ITK-SNAP
is open-source software distributed under the GNU General Public
License. ITK-SNAP is written in C++ and it leverages the Insight
Segmentation and Registration Toolkit (ITK) library. See
<code>Summary and Setup</code> section for requirements and installation
of ITK-SNAP</p>
</div>
</div>
<div class="section level3">
<h3 id="itk-snap-application">ITK-SNAP application<a class="anchor" aria-label="anchor" href="#itk-snap-application"></a>
</h3>
<p>ITK-SNAP application shows three orthogonal slices and a fourth
window for three-dimensional view segmentation.</p>
<figure><img src="../fig/itk-snap-main-window.svg" alt="Figure. Description of ITK-SNAP tools in the main window using MRI-crop example datasets for plane and 3D views." class="figure mx-auto d-block"><div class="figcaption">Figure. Description of ITK-SNAP tools in the
main window using <a href="http://www.nitrc.org/frs/download.php/750/MRI-crop.zip" class="external-link">MRI-crop
example datasets</a> for plane and 3D views.</div>
</figure>
</div>
</section><section><h2 class="section-heading" id="viewing-and-understanding-dicom-data">Viewing and understanding DICOM data<a class="anchor" aria-label="anchor" href="#viewing-and-understanding-dicom-data"></a>
</h2>
<hr class="half-width">
<p>We are using CT Lung DICOM dataset from
<code>CT-PET-VI-02/CT_for_PET</code>, containing 175 dicom items and
totalling 92.4 MB.</p>
<div class="section level3">
<h3 id="opening-and-viewing-dicom-images">Opening and Viewing DICOM images<a class="anchor" aria-label="anchor" href="#opening-and-viewing-dicom-images"></a>
</h3>
<ul>
<li><strong>Open ITK-SNAP application</strong></li>
<li>
<strong>Load inhale scan using file browser</strong>
<ul>
<li>Open the itk-snap application. If you have used it before it will
display recent images when you open it, and you can select one of these
to open it.</li>
</ul>
If the image you want to open is not listed under recent images, you can
open it either by clicking the ‘Open Image…’ button at the bottom right
of the window, or File-&gt;Open Main Image. When you do this a small
window opens where you can enter the path of the file you want to open,
or click Browse in your file explorer (exFinder in Mac and nautilus in
Ubuntu) to open a file browser (for instance,
“CT-PET-VI-02/CT_for_PET”). Do this and select the first slice from the
Inhale_BH_CT folder, which is called 1-001.dcm. The set the File Format
to DICOM Image Series and then click <code>Next</code>. You will then be
asked to Select DICOM series to open, but as this folder only includes
one series you can just click <code>Next</code>. Click
<code>Finish</code>
</li>
</ul>
<figure><img src="../fig/itk-snap-opening-dicoms.svg" alt="Figure. ITK-SNAP opening image file" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP opening image file</div>
</figure><figure><img src="../fig/itk-snap-viewing-dicoms.svg" alt="Figure. ITK-SNAP main window" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP main window</div>
</figure>
</div>
<div class="section level3">
<h3 id="navigating-dicom-images">Navigating DICOM images<a class="anchor" aria-label="anchor" href="#navigating-dicom-images"></a>
</h3>
<ul>
<li>Navigate around image, see intensity value, and adjust intensity
window</li>
<li>To navigate around the image, i.e. change the displayed slices, you
can left clicking in the displayed slices, using the mouse wheel, or the
slider next to the displayed slices.</li>
<li>To zoom, you can use the right mouse button (or control + button 1),
and pan using the centre mouse button (or alt + button 1).</li>
</ul>
<figure><img src="../fig/itk-snap-cursor-inspector.png" alt="Figure. ITK-SNAP cursor inspector" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP cursor inspector</div>
</figure>
</div>
<div class="section level3">
<h3 id="handling-multiple-dicom-images">Handling multiple DICOM images<a class="anchor" aria-label="anchor" href="#handling-multiple-dicom-images"></a>
</h3>
<p>We provide instructions for handling multiple DICOM images, applying
overlays, viewing image information, and using color maps in ITK-SNAP.
For this exmaple, we are using <code>CT-PET-VI-02/inhale_BH_CT</code>
and <code>CT-PET-VI-02/exhale_BH_CT</code> dicoms.</p>
<div class="section level4">
<h4 id="load-additional-image-using-exhale_bh_ct-scan-by-drag-and-drop">Load additional image using <code>exhale_BH_CT</code> scan by drag
and drop<a class="anchor" aria-label="anchor" href="#load-additional-image-using-exhale_bh_ct-scan-by-drag-and-drop"></a>
</h4>
<ul>
<li>Images can also be opened by simply dragging them on to the ITK-SNAP
window. In a file explorer (Finder in Mac) go to the
<code>exhale_BH_CT</code> folder and drag any of the dicom files on to
the itksnap window. A small window will pop up asking What should
itksnap do with this image? If you select Load as Main Image it will
replace the current image. Instead select Load as Additional Image -
this will enable easy comparison of the two images.</li>
</ul>
<figure><img src="../fig/itk-snap-additional-image.svg" alt="Figure. ITK-SNAP additional image" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP additional image</div>
</figure>
</div>
<div class="section level4">
<h4 id="using-thumbnails-to-see-image-differences">Using thumbnails to see image differences<a class="anchor" aria-label="anchor" href="#using-thumbnails-to-see-image-differences"></a>
</h4>
<ul>
<li>Once the second image is loaded you will see two thumbnails in the
top corner of each slice display</li>
<li>Click on these to swap the displayed slices from one image to the
other - this will enable you to easily see the similarities and
differences between the images.</li>
<li>You will also see that both images now appear in the Cursor
Inspector, where you can see the intensity value at the cursor for both
images.</li>
<li>You can also change the displayed image by clicking on it in the
Cursor Inspector</li>
</ul>
<figure><img src="../fig/itk-snap-thumbnails.png" alt="Figure. ITK-SNAP thumbnails, handlding two DICOM images (inhale_BH_CT and exhale_BH_CT for CT-PET-VI-02)" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP thumbnails, handlding two DICOM
images (<code>inhale_BH_CT</code> and <code>exhale_BH_CT</code> for
<code>CT-PET-VI-02</code>)</div>
</figure>
</div>
<div class="section level4">
<h4 id="colour-overlay">Colour overlay<a class="anchor" aria-label="anchor" href="#colour-overlay"></a>
</h4>
<p>In some cases you may want to display an image as a colour overlay on
top of another image, e.g. displaying a PET image overlaid on the
corresponding CT.</p>
<div class="section level5">
<h5 id="colour-overlay-as-a-separate-image-shown-besides-other-images">Colour overlay as a separate image (shown besides other images)<a class="anchor" aria-label="anchor" href="#colour-overlay-as-a-separate-image-shown-besides-other-images"></a>
</h5>
<ul>
<li>
<strong>Load Primary Image</strong>:
<ul>
<li>Open your primary DICOM series of the
<code>CT-PET-VI-02/CT_for_PET</code> image either using the drag and
drop method or <code>File-&gt;Open Image</code> as described above.</li>
<li>Make sure File Format is DICOM Image Series.</li>
<li>This time select Load as Main Image. This will load in the new image
replacing the two that were previously loaded.</li>
</ul>
</li>
<li>
<strong>Load Overlay Image</strong>:
<ul>
<li>Load the <code>CT-PET-VI-02/PET</code> image either using the drag
and drop method or <code>File-&gt;Open Image</code>
</li>
</ul>
</li>
</ul>
<figure><img src="../fig/itk-snap-colour-overlay-as-separate-image.svg" alt="Figure. ITK-SNAP thumbnails" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP thumbnails</div>
</figure>
</div>
<div class="section level5">
<h5 id="colour-overlay-as-a-semi-transparent-overlay-shown-on-the-top-of-other-images">Colour overlay as a semi-transparent overlay (shown on the top of
other images)<a class="anchor" aria-label="anchor" href="#colour-overlay-as-a-semi-transparent-overlay-shown-on-the-top-of-other-images"></a>
</h5>
<ul>
<li>
<strong>Load Primary Image</strong>:
<ul>
<li>Open your primary DICOM series of the
<code>CT-PET-VI-02/CT_for_PET</code> image either using the drag and
drop method or <code>File-&gt;Open Image</code> as described above.</li>
<li>Make sure File Format is DICOM Image Series.</li>
<li>Select Load as Main Image.</li>
</ul>
</li>
<li>
<strong>Load Overlay Image</strong>:
<ul>
<li>Load the <code>CT-PET-VI-02/PET</code> image either using the drag
and drop method or <code>File-&gt;Open Image</code>
</li>
<li>When the image has loaded select As a semi-transparent overlay. You
can also set the overlay color map here - select <code>Hot</code> from
the drop-down menu and click Next.</li>
<li>The image summary will then be displayed, along with a warning about
possible loss of precision (which can be ignored). Click Finish</li>
</ul>
</li>
</ul>
<figure><img src="../fig/itk-snap-colour-overlay-as-semi-transparent-image.svg" alt="Figure. ITK-SNAP semi-transparent overlays" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP semi-transparent overlays</div>
</figure>
</div>
</div>
</div>
<div class="section level3">
<h3 id="layer-inspector-tools">Layer inspector tools<a class="anchor" aria-label="anchor" href="#layer-inspector-tools"></a>
</h3>
<ul>
<li><p>Load <code>CT-PET-VI-02/CT_for_PET</code> and
<code>CT-PET-VI-02/PET</code> scan datasets, using hot semi-transparency
(as shown above).</p></li>
<li><p>Go to <code>Tools-&gt;Layer Inspector</code>. This opens the
Image Layer Inspector window. You will see the two images on the left,
and five tabs along the top of the window.</p></li>
<li><p>PET image appears in Cursor Inspector (called Galligas Lung) in
italic and CT image as CT Lung in bold.</p></li>
<li>
<p><strong>The General tab</strong> displays the filename and the
nickname for the selected image.</p>
<ul>
<li>The Nickname can be edited. For the PET image the general tab also
displays a slider to set the opacity, and the option to display it as a
separate image or semi-transparent overlay.</li>
</ul>
</li>
</ul>
<figure><img src="../fig/itk-snap-layer-inspector-general-tab.png" alt="Figure. ITK-SNAP: Layer inspector with general tab" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP: Layer inspector with general
tab</div>
</figure><ul>
<li>
<strong>The Contrast tab</strong> enables you to adjust how the
image intensities are displayed for the different images, e.g. Select
the lung image and set the maximum value to 1000 (push enter after
typing the number) and this will make the structures in the lung easier
to see.</li>
</ul>
<figure><img src="../fig/itk-snap-layer-inspector-contrast-tab.png" alt="Figure. ITK-SNAP: Layer inspector with contrast tab" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP: Layer inspector with contrast
tab</div>
</figure><ul>
<li>
<strong>The color map tab</strong> can be used to select and
manipulate the colour map
<ul>
<li>One of the key elements of an imaging viewer is to provide different
means to map those values into grey scales or different colors.</li>
<li>We will show you how to apply different color maps or lookup tables
to your data and how this affects how the images are presented to the
user.</li>
</ul>
<ol style="list-style-type: decimal">
<li><p><strong>Load the Image</strong>: - Open the desired DICOM
series.</p></li>
<li><p><strong>Open Color Map Settings</strong>: - Go to
<code>Tools</code> &gt; <code>Color Maps Editor</code>.</p></li>
<li><p><strong>Apply and Adjust Color Map</strong>: - Choose a
predefined color map from the list. You might also create a customised
map. - Adjust the intensity and transparency settings as needed to
enhance the visualisation of the images.</p></li>
</ol>
</li>
</ul>
<figure><img src="../fig/itk-snap-layer-inspector-color-map-tab.png" alt="Figure. ITK-SNAP: Layer inspector with color map tab" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP: Layer inspector with color map
tab</div>
</figure><ul>
<li>
<strong>The info tab</strong> displays the Image Header information
for the images and also gives the Cursor Coordinates in both Voxel and
World units.
<ul>
<li>A dialog box will appear displaying metadata and other relevant
information about the loaded DICOM images (e.g. values for image header
and cursor coordinates).</li>
<li>If you look at the info tab for both the CT image and PET image you
will see that the header information for the images is different, and
the cursor coordinates in voxel units for the PET image are not whole
numbers.</li>
<li>This is because the displayed slices are from the main (CT) image,
and the overlaid (PET) image slices are interpolated at the
corresponding locations.</li>
</ul>
</li>
</ul>
<figure><img src="../fig/itk-snap-layer-inspector-info-tab.png" alt="Figure. ITK-SNAP: Layer inspector with info tab" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP: Layer inspector with info
tab</div>
</figure><ul>
<li>
<strong>The metadata tab</strong> contains (some of) the information
from the DICOM header of the images</li>
</ul>
<figure><img src="../fig/itk-snap-layer-inspector-metadata-tab.png" alt="Figure. ITK-SNAP: Layer inspector with metadata tab" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP: Layer inspector with metadata
tab</div>
</figure>
</div>
<div class="section level3">
<h3 id="converting-dicom-images-to-nifti">Converting DICOM images to NifTi<a class="anchor" aria-label="anchor" href="#converting-dicom-images-to-nifti"></a>
</h3>
<p>As mentioned earlier in the exercise, the NIfTI image format tends to
be much easier to work with when processing and analysing medical image
data. We will now work on converting DICOM images to a NIfTI image
volume.</p>
<div class="section level4">
<h4 id="using-itk-snap">Using ITK-SNAP<a class="anchor" aria-label="anchor" href="#using-itk-snap"></a>
</h4>
<p>In the ITK-SNAP application, save the file by clicking ‘File’ –&gt;
‘Save image’ –&gt; rename image and choose format as ‘NiFTI’.</p>
<div id="accordionSpoiler3" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler3" aria-expanded="false" aria-controls="collapseSpoiler3">
  <h3 class="accordion-header" id="headingSpoiler3">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Warning for Linux users.
  </h3>
</button>
<div id="collapseSpoiler3" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler3" aria-labelledby="headingSpoiler3">
<div class="accordion-body">
<p>You might get this error
<code>Error: exception occurred during image IO. Exception: std::expedition</code>
to which we suggest using dicom2nifti library.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level4">
<h4 id="using-dicom2nifti">Using <a href="https://github.com/icometrix/dicom2nifti" class="external-link">dicom2nifti</a>
<a class="anchor" aria-label="anchor" href="#using-dicom2nifti"></a>
</h4>
<ol style="list-style-type: decimal">
<li>Open terminal, activate <code>mirVE</code> environment and run
python</li>
</ol>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">conda</span> activate mirVE</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">python</span></span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Run the following commands to convert your DICOM scans to nifti
format.</li>
</ol>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path </span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="im">import</span> dicom2nifti </span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>dicom_path <span class="op">=</span> Path(<span class="st">"CT_for_PET"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>dicom2nifti.convert_directory(dicom_path, <span class="st">"."</span>, compression<span class="op">=</span><span class="va">True</span>, reorient<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>pet_dicom_path <span class="op">=</span> Path(<span class="st">"PET"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>dicom2nifti.convert_directory(pet_dicom_path, <span class="st">"."</span>, compression<span class="op">=</span><span class="va">True</span>, reorient<span class="op">=</span><span class="va">True</span>)</span></code></pre>
</div>
<p>Creating the following files:</p>
<pre><code>`3_ct_lung__30__b31f.nii.gz` [47M] and renamed as `ct_for_pet.nii.gz`
`4_galligas_lung.nii.gz` [12M] and renamed as `pet.nii.gz`</code></pre>
</div>
<div class="section level4">
<h4 id="using-others-packages">Using others packages<a class="anchor" aria-label="anchor" href="#using-others-packages"></a>
</h4>
<p>You might also be interested to look other packages: * <a href="https://github.com/rordenlab/dcm2niix" class="external-link uri">https://github.com/rordenlab/dcm2niix</a> * <a href="https://nipy.org/nibabel/dicom/dicom.html#dicom" class="external-link uri">https://nipy.org/nibabel/dicom/dicom.html#dicom</a> * <a href="https://neuroimaging-cookbook.github.io/recipes/dcm2nii_recipe/" class="external-link uri">https://neuroimaging-cookbook.github.io/recipes/dcm2nii_recipe/</a></p>
</div>
</div>
</section><section><h2 class="section-heading" id="viewing-and-understanding-the-nifti-header-with-nibabel">Viewing and understanding the NifTi header with NiBabel<a class="anchor" aria-label="anchor" href="#viewing-and-understanding-the-nifti-header-with-nibabel"></a>
</h2>
<hr class="half-width">
<p>We are going to use the python package <a href="https://nipy.org/nibabel/" class="external-link">NiBabel</a> to upload
<code>NifTI</code> images and learn some basic properties of the image
using Nibabel. <a href="https://nipy.org/nibabel/api.html#api" class="external-link"><code>nibabel</code>
api</a> provides various image utilities, conversions methods, helpers.
We recommend to checking <a href="https://nipy.org/nibabel/#documentation" class="external-link">documentation</a> for
further deatils on using nibabel library. Please see <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/tree/main/_dependencies" class="external-link">instructions</a>
to install <code>NiBabel</code> package and other dependecies.</p>
<div class="section level3">
<h3 id="loading-images">Loading images<a class="anchor" aria-label="anchor" href="#loading-images"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Open terminal, activate <code>mirVE</code> environment and run
python</li>
</ol>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">conda</span> activate mirVE</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="ex">python</span></span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Importing python packages under <code>*/episodes</code> path</li>
</ol>
<p>A NifTi image with extension <code>*.nii.gz</code> can be read using
<code>nibabel</code>’s <code>load</code> function.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="im">import</span> nibabel <span class="im">as</span> nib</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>nii3ct <span class="op">=</span> nib.load(<span class="st">"data/ct_for_pet.nii.gz"</span>)</span></code></pre>
</div>
<pre class="callout"><code>`NiBabel`'s `load` function does not actually read the image data itself from disk, but
does read and interpret the header, and provides functions for accessing the image data.
Calling these functions reads the data from disk (unless it has already been read, in which
case it may be cached in memory already.</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>
<code>NifTI</code> object type, shape/size The Nifti1Image object
allows us to see the size/shape of the image and its data type.</li>
</ol>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(nii3ct))</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co"># &lt;class 'nibabel.nifti1.Nifti1Image'&gt;</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct.get_data_dtype())</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">#int16</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>nii3ct.shape</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="co"># (512, 512, 175)</span></span></code></pre>
</div>
<ol start="3" style="list-style-type: decimal">
<li>Affine transform, mapping from voxel space to world space There are
two common ways of specifying the affine transformation mapping from
voxel coordinates to world coordinates in the nifti header, called the
<code>sform</code> and the `qform’. Another transformation is that
neither the sform or qform is used the mapping is performed based just
on the voxel dimensions. The <strong>sform</strong> directly stores the
affine transformation in the header whereas the <strong>qform</strong>
stores the affine transformation using <a href="https://en.wikipedia.org/wiki/Quaternion" class="external-link">quaternions</a>.</li>
</ol>
<div id="accordionSpoiler4" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler4" aria-expanded="false" aria-controls="collapseSpoiler4">
  <h3 class="accordion-header" id="headingSpoiler4">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Recommending sform over qform
  </h3>
</button>
<div id="collapseSpoiler4" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler4" aria-labelledby="headingSpoiler4">
<div class="accordion-body">
<p>We strongly advise always using the <code>sform</code> over the
<code>qform</code>, as: * It is easier to understand (at least for
instructors). * It can contain shears which cannot be represented using
the <code>qform</code>.</p>
</div>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>nii3ct.affine</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="co">#array([[  -0.9765625 ,    0.        ,    0.        ,  249.51171875],</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="co">#       [  -0.        ,    0.9765625 ,    0.        ,  -33.01171875],</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co">#       [   0.        ,   -0.        ,    2.        , -553.5       ],</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="co">#       [   0.        ,    0.        ,    0.        ,    1.        ]])</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="header-features">Header features<a class="anchor" aria-label="anchor" href="#header-features"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Printing <code>nii3ct.header</code> outputs</li>
</ol>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct.header)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">#&lt;class 'nibabel.nifti1.Nifti1Header'&gt; object, endian='&lt;'</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#sizeof_hdr      : 348</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">#data_type       : b''</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">#db_name         : b''</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">#extents         : 0</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co">#session_error   : 0</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co">#regular         : b''</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">#dim_info        : 0</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co">#dim             : [  3 512 512 175   1   1   1   1]</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co">#intent_p1       : 0.0</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="co">#intent_p2       : 0.0</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="co">#intent_p3       : 0.0</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co">#intent_code     : none</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">#datatype        : int16</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co">#bitpix          : 16</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">#slice_start     : 0</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co">#pixdim          : [-1.         0.9765625  0.9765625  2.         1.         1.</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="co">#  1.         1.       ]</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co">#vox_offset      : 0.0</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">#scl_slope       : nan</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">#scl_inter       : nan</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#slice_end       : 0</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co">#slice_code      : unknown</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">#xyzt_units      : 2</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#cal_max         : 0.0</span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="co">#cal_min         : 0.0</span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a><span class="co">#slice_duration  : 0.0</span></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="co">#toffset         : 0.0</span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="co">#glmax           : 0</span></span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="co">#glmin           : 0</span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a><span class="co">#descrip         : b''</span></span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a><span class="co">#aux_file        : b''</span></span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a><span class="co">#qform_code      : unknown</span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a><span class="co">#sform_code      : aligned</span></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a><span class="co">#quatern_b       : 0.0</span></span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="co">#quatern_c       : 1.0</span></span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a><span class="co">#quatern_d       : 0.0</span></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a><span class="co">#qoffset_x       : 249.51172</span></span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a><span class="co">#qoffset_y       : -33.01172</span></span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a><span class="co">#qoffset_z       : -553.5</span></span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a><span class="co">#srow_x          : [ -0.9765625   0.          0.        249.51172  ]</span></span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a><span class="co">#srow_y          : [ -0.          0.9765625   0.        -33.01172  ]</span></span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a><span class="co">#srow_z          : [   0.    -0.     2.  -553.5]</span></span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a><span class="co">#intent_name     : b''</span></span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a><span class="co">#magic           : b'n+1'</span></span></code></pre>
</div>
<ul>
<li><p><code>sform</code> transformation matrix You can see that the
<code>sform</code> is stored in the <code>srow_x</code>,
<code>srow_y</code>, and <code>srow_z</code> fields of the header. These
specify the top three rows of a 4x4 matrix representing an affine
transformation using homogeneous coordinates. The fourth row is not
stored as it is always <code>[0 0 0 1]</code>. You will notice that the
sform matrix matches the affine transform in the
<code>Nifti1Image</code> object.</p></li>
<li><p><code>sform_code</code> and <code>qform_code</code> It can also
be seen from the <code>sform_code</code> and <code>qform_code</code>
that both the sform and qform are set for this image. There are 5
different sform/qform codes defined:</p></li>
</ul>
<table class="table">
<thead><tr class="header">
<th>Code</th>
<th>Label</th>
<th>Meaning</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>unknown</td>
<td>sform not defined</td>
</tr>
<tr class="even">
<td>1</td>
<td>scanner</td>
<td>RAS+ is scanner coordinates</td>
</tr>
<tr class="odd">
<td>2</td>
<td>aligned</td>
<td>RAS+ aligned to some other scan</td>
</tr>
<tr class="even">
<td>3</td>
<td>talairach</td>
<td>RAS+ in Talairach atlas space</td>
</tr>
<tr class="odd">
<td>4</td>
<td>mni</td>
<td>RAS+ in MNI atlas space</td>
</tr>
</tbody>
</table>
<div id="accordionSpoiler5" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler5" aria-expanded="false" aria-controls="collapseSpoiler5">
  <h3 class="accordion-header" id="headingSpoiler5">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Which code to use?
  </h3>
</button>
<div id="collapseSpoiler5" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler5" aria-labelledby="headingSpoiler5">
<div class="accordion-body">
<p>But for most purposes all that matters is whether the code is unknown
(numerical value 0) or one of the other valid values. If the code is
unknown then the sform/qform is not specified (and any values provided
in the sform/qform fields of the header will be ignored). For any other
valid values the sform/qform is specified and the affine transform will
be determined from the corresponding header values.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="qform-transform">
<code>qform</code> transform<a class="anchor" aria-label="anchor" href="#qform-transform"></a>
</h3>
<p>You can also see <code>qform</code> transform using the
<code>get_qform</code> function, which returns the affine matrix
represented by the qform:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct.get_qform())</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">#[[  -0.9765625     0.            0.          249.51171875]</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co"># [   0.            0.9765625     0.          -33.01171875]</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co"># [   0.            0.            2.         -553.5       ]</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co"># [   0.            0.            0.            1.        ]]</span></span></code></pre>
</div>
<div id="accordionSpoiler6" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler6" aria-expanded="false" aria-controls="collapseSpoiler6">
  <h3 class="accordion-header" id="headingSpoiler6">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Advincing on using sform
  </h3>
</button>
<div id="collapseSpoiler6" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler6" aria-labelledby="headingSpoiler6">
<div class="accordion-body">
<p>However, the nifti format does not require that the sform and qform
specify the same matrix. It is also not well defined what should be done
when they are both provided and are different from each other. Often the
<code>qform</code> is simply ignored and the <code>sform</code> is used,
so the general advice is to only use the <code>sform</code> and set the
<code>qform</code> to unknown to avoid any confusion.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="coordinate-system">Coordinate system<a class="anchor" aria-label="anchor" href="#coordinate-system"></a>
</h3>
<div class="section level4">
<h4 id="lps">LPS<a class="anchor" aria-label="anchor" href="#lps"></a>
</h4>
<p>The original DICOM images assume the world coordinate system is LPS
(i.e. values increase when moving to the left, posterior, and superior).
See this helpful information on <a href="https://nipy.org/nibabel/dicom/dicom_orientation.html" class="external-link">DICOM
orientations</a>, and determine if you obtained a similar affine
transform from the DICOM headers. The values in the first two rows
corresponding to the x and y dimensions would be the negative of those
in the NifTi header.</p>
</div>
<div class="section level4">
<h4 id="ras">RAS<a class="anchor" aria-label="anchor" href="#ras"></a>
</h4>
<p>You will notice that the diagonal elements of the affine matrix match
the voxel dimensions (as the affine matrix does not contain any
rotations), but the values for the x and y dimensions are negative. This
is because the voxel indices increase as you move to the left and
posterior of the image/patient, but the nifti format assumes a RAS world
coordinate system (i.e. the values increase as you move to the right and
anterior of the patient). Therefore, the world coordinates decrease as
the voxel indices increase.</p>
</div>
<div class="section level4">
<h4 id="itk-snap-visualisation-coordinate-system">ITK-SNAP visualisation coordinate system<a class="anchor" aria-label="anchor" href="#itk-snap-visualisation-coordinate-system"></a>
</h4>
<p>ITK-SNAP provides the option, <code>Tools&gt;Reorient Image</code>,
to set image orientation using three-letter code (<strong>RAI</strong>
code), describing the image rows, columns, and slice map to the
anatomical coordinates. For example, the code <strong>ASL</strong> means
that image rows (X) run from <strong>A</strong>nterior to
<strong>P</strong>osterior, image columns (Y) run from
<strong>S</strong>uperior to <strong>I</strong>nferior, and images
slices (Z) run from <strong>L</strong>eft to <strong>R</strong>ight.</p>
<figure><img src="../fig/itk-snap-tools-reorient-image.png" alt="Figure. ITK-SNAP Reorient image" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP Reorient image</div>
</figure>
</div>
</div>
</section><section><h2 class="section-heading" id="modifying-nifti-images-and-headers-with-nibabel">Modifying <code>NifTi</code> images and headers with Nibabel<a class="anchor" aria-label="anchor" href="#modifying-nifti-images-and-headers-with-nibabel"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="obtaining-image-pixel-data">Obtaining image pixel data<a class="anchor" aria-label="anchor" href="#obtaining-image-pixel-data"></a>
</h3>
<p>The image data for a Nifti1Image object can be accessed using the
<code>get_fdata</code> function. This will load the data from disk and
cast it to float64 type before returning the data as a
<code>numpy</code> array.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>image_data<span class="op">=</span>nii3ct.get_fdata()</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(image_data))</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co">#&lt;class 'numpy.ndarray'&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="bu">print</span>(image_data.dtype, image_data.shape)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co">#float64 (512, 512, 175)</span></span></code></pre>
</div>
<p>You can also plot a particular slide, (e.g. 140) for such data.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>plt.imshow(image_data[:,:,<span class="dv">140</span>], cmap<span class="op">=</span><span class="st">"gray"</span>)<span class="op">;</span> plt.show()</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co">#launch plot window</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="using-float64-data-type">Using float64 data type<a class="anchor" aria-label="anchor" href="#using-float64-data-type"></a>
</h3>
<p>Casting image data to float64 prevents any integer-related errors and
problems in downstream processing when using the data read by NiBabel.
However, this does not change the type of the image stored on disk,
which as we have seen is int16 for this image, and this could still lead
to downstream errors or unexpected behaviour for any processing that
works directly on the images stored on disk. We are going to convert the
image saved on disk to a floating point image, using the
<code>set_data_dtype</code> function to set the data type to float32.
Essentially, we are going to use 32 bit rather than 64 bit floating
point, as this is usually sufficiently accurate.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct.get_data_dtype())</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">#int16</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>nii3ct.set_data_dtype(np.float32)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="bu">print</span>(nii3ct.get_data_dtype())</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co">#float32</span></span></code></pre>
</div>
<p>We are also going to set the <code>qform</code> to
<code>unknown</code>, updating the corresponding fields in the header.
We use the <code>set_qform</code> function to set the <code>qform</code>
code. To just set the code and not modify the other <code>qform</code>
values in the header, the first input should be <code>None</code>. It is
not necessary to modify the other <code>qform</code> values as they
should be ignored when the code is set to unknown.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>nii3ct.set_qform(<span class="va">None</span>, code <span class="op">=</span> <span class="st">'unknown'</span>)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="bu">print</span>(nii3ct.header)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>...</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>qform_code      : unknown</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>...</span></code></pre>
</div>
<p>The floating point image can now be written to disk using the save
function.</p>
<div id="accordionSpoiler7" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler7" aria-expanded="false" aria-controls="collapseSpoiler7">
  <h3 class="accordion-header" id="headingSpoiler7">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  We do not need to manually modify the type of the image data?
  </h3>
</button>
<div id="collapseSpoiler7" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler7" aria-labelledby="headingSpoiler7">
<div class="accordion-body">
<p>Setting the data type for the Nifti1Image object tells it which type
to use when writing the image data to disk.</p>
</div>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>nib.save(nii3ct, <span class="st">'data/ct_for_pet_float32.nii.gz'</span>)</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="bit-integers-vs-32-bit-floats">16-bit integers vs 32 bit floats<a class="anchor" aria-label="anchor" href="#bit-integers-vs-32-bit-floats"></a>
</h3>
<p>The file size of <code>ct_for_pet_float32.nii.gz</code> is larger
than <code>ct_for_pet.nii.gz</code> (61 MB, 47 MB, respectively) because
of the conversion from 16 bit integers to 32 bit floats. Both images are
compressed, but the compression is more efficient for the floating point
image: while a 32-bit floating point variable is twice the size of a
16-bit integer, the floating image is less than double the size of the
original integer image.</p>
<ul>
<li>int16</li>
</ul>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>nii3ct_int16 <span class="op">=</span> nib.load(<span class="st">"data/ct_for_pet.nii.gz"</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct_int16.get_data_dtype())</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="co">#int16</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct_int16.header)</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="co">#&lt;class 'nibabel.nifti1.Nifti1Header'&gt; object, endian='&lt;'</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="co">#sizeof_hdr      : 348</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="co">#data_type       : b''</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="co">#db_name         : b''</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co">#extents         : 0</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="co">#session_error   : 0</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co">#regular         : b''</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co">#dim_info        : 0</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="co">#dim             : [  3 512 512 175   1   1   1   1]</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="co">#intent_p1       : 0.0</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="co">#intent_p2       : 0.0</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="co">#intent_p3       : 0.0</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a><span class="co">#intent_code     : none</span></span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a><span class="co">#datatype        : int16</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a><span class="co">#bitpix          : 16</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a><span class="co">#slice_start     : 0</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a><span class="co">#pixdim          : [-1.         0.9765625  0.9765625  2.         1.         1.</span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a><span class="co">#  1.         1.       ]</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a><span class="co">#vox_offset      : 0.0</span></span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a><span class="co">#scl_slope       : nan</span></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a><span class="co">#scl_inter       : nan</span></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a><span class="co">#slice_end       : 0</span></span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a><span class="co">#slice_code      : unknown</span></span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a><span class="co">#xyzt_units      : 2</span></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a><span class="co">#cal_max         : 0.0</span></span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a><span class="co">#cal_min         : 0.0</span></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a><span class="co">#slice_duration  : 0.0</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a><span class="co">#toffset         : 0.0</span></span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a><span class="co">#glmax           : 0</span></span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a><span class="co">#glmin           : 0</span></span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a><span class="co">#descrip         : b''</span></span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a><span class="co">#aux_file        : b''</span></span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a><span class="co">#qform_code      : unknown</span></span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a><span class="co">#sform_code      : aligned</span></span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a><span class="co">#quatern_b       : 0.0</span></span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a><span class="co">#quatern_c       : 1.0</span></span>
<span id="cb25-38"><a href="#cb25-38" tabindex="-1"></a><span class="co">#quatern_d       : 0.0</span></span>
<span id="cb25-39"><a href="#cb25-39" tabindex="-1"></a><span class="co">#qoffset_x       : 249.51172</span></span>
<span id="cb25-40"><a href="#cb25-40" tabindex="-1"></a><span class="co">#qoffset_y       : -33.01172</span></span>
<span id="cb25-41"><a href="#cb25-41" tabindex="-1"></a><span class="co">#qoffset_z       : -553.5</span></span>
<span id="cb25-42"><a href="#cb25-42" tabindex="-1"></a><span class="co">#srow_x          : [ -0.9765625   0.          0.        249.51172  ]</span></span>
<span id="cb25-43"><a href="#cb25-43" tabindex="-1"></a><span class="co">#srow_y          : [ -0.          0.9765625   0.        -33.01172  ]</span></span>
<span id="cb25-44"><a href="#cb25-44" tabindex="-1"></a><span class="co">#srow_z          : [   0.    -0.     2.  -553.5]</span></span>
<span id="cb25-45"><a href="#cb25-45" tabindex="-1"></a><span class="co">#intent_name     : b''</span></span>
<span id="cb25-46"><a href="#cb25-46" tabindex="-1"></a><span class="co">#magic           : b'n+1'</span></span></code></pre>
</div>
<ul>
<li>float32</li>
</ul>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>nii3ct_float32 <span class="op">=</span> nib.load(<span class="st">"data/ct_for_pet_float32.nii.gz"</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct_float32.get_data_dtype())</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="co">#float32</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct_float32.header)</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="co">#&lt;class 'nibabel.nifti1.Nifti1Header'&gt; object, endian='&lt;'</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="co">#sizeof_hdr      : 348</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="co">#data_type       : b''</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="co">#db_name         : b''</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="co">#extents         : 0</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="co">#session_error   : 0</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="co">#regular         : b''</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="co">#dim_info        : 0</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a><span class="co">#dim             : [  3 512 512 175   1   1   1   1]</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="co">#intent_p1       : 0.0</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a><span class="co">#intent_p2       : 0.0</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a><span class="co">#intent_p3       : 0.0</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a><span class="co">#intent_code     : none</span></span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a><span class="co">#datatype        : float32</span></span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a><span class="co">#bitpix          : 32</span></span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a><span class="co">#slice_start     : 0</span></span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a><span class="co">#pixdim          : [-1.         0.9765625  0.9765625  2.         1.         1.</span></span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a><span class="co">#  1.         1.       ]</span></span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a><span class="co">#vox_offset      : 0.0</span></span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a><span class="co">#scl_slope       : nan</span></span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a><span class="co">#scl_inter       : nan</span></span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a><span class="co">#slice_end       : 0</span></span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a><span class="co">#slice_code      : unknown</span></span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a><span class="co">#xyzt_units      : 2</span></span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a><span class="co">#cal_max         : 0.0</span></span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a><span class="co">#cal_min         : 0.0</span></span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a><span class="co">#slice_duration  : 0.0</span></span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a><span class="co">#toffset         : 0.0</span></span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a><span class="co">#glmax           : 0</span></span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a><span class="co">#glmin           : 0</span></span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a><span class="co">#descrip         : b''</span></span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a><span class="co">#aux_file        : b''</span></span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a><span class="co">#qform_code      : unknown</span></span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a><span class="co">#sform_code      : aligned</span></span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a><span class="co">#quatern_b       : 0.0</span></span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a><span class="co">#quatern_c       : 1.0</span></span>
<span id="cb28-38"><a href="#cb28-38" tabindex="-1"></a><span class="co">#quatern_d       : 0.0</span></span>
<span id="cb28-39"><a href="#cb28-39" tabindex="-1"></a><span class="co">#qoffset_x       : 249.51172</span></span>
<span id="cb28-40"><a href="#cb28-40" tabindex="-1"></a><span class="co">#qoffset_y       : -33.01172</span></span>
<span id="cb28-41"><a href="#cb28-41" tabindex="-1"></a><span class="co">#qoffset_z       : -553.5</span></span>
<span id="cb28-42"><a href="#cb28-42" tabindex="-1"></a><span class="co">#srow_x          : [ -0.9765625   0.          0.        249.51172  ]</span></span>
<span id="cb28-43"><a href="#cb28-43" tabindex="-1"></a><span class="co">#srow_y          : [ -0.          0.9765625   0.        -33.01172  ]</span></span>
<span id="cb28-44"><a href="#cb28-44" tabindex="-1"></a><span class="co">#srow_z          : [   0.    -0.     2.  -553.5]</span></span>
<span id="cb28-45"><a href="#cb28-45" tabindex="-1"></a><span class="co">#intent_name     : b''</span></span>
<span id="cb28-46"><a href="#cb28-46" tabindex="-1"></a><span class="co">#magic           : b'n+1'</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="itk-snap-visualistaion-of-16-bit-integers-vs-32-bit-floats">ITK-SNAP visualistaion of 16-bit integers vs 32 bit floats<a class="anchor" aria-label="anchor" href="#itk-snap-visualistaion-of-16-bit-integers-vs-32-bit-floats"></a>
</h4>
<figure><img src="../fig/itk-snap-16-32-bits.svg" alt="Figure. ITK-SNAP: Metadata for 16-bit integers vs 32-bit floats" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP: Metadata for 16-bit integers
vs 32-bit floats</div>
</figure>
</div>
</div>
<div class="section level3">
<h3 id="cropping-data">Cropping data<a class="anchor" aria-label="anchor" href="#cropping-data"></a>
</h3>
<p>Cropping data might often contain background voxels which can be
useful in some instances but might take up valuable RAM memory,
especially for large images. We are going to crop the image from slice
103 to slice 381 in the x dimension (Sagittal slices) and from slice 160
to 340 in the y dimension (Coronal slices). Use ITK-SNAP to confirm that
cropping the image to these slices will only remove slices that do not
contain the patient.</p>
<div id="accordionSpoiler8" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler8" aria-expanded="false" aria-controls="collapseSpoiler8">
  <h3 class="accordion-header" id="headingSpoiler8">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Notes on Nifti1Image object
  </h3>
</button>
<div id="collapseSpoiler8" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler8" aria-labelledby="headingSpoiler8">
<div class="accordion-body">
<p>It is not possible to change the image data in a Nifti1Image object,
e.g. to use a smaller array corresponding to a cropped image. Therefore,
if you want to modify the image data you need to create a new array with
the modified data, then create a new Nifti1Image object using this new
array which is used to save the modified image to disk.</p>
</div>
</div>
</div>
</div>
<ul>
<li>Read the image data from disk using <code>get_fdata</code> and then
create a new array containing a copy of the desired slices:</li>
</ul>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>nii3ct_float32 <span class="op">=</span> nib.load(<span class="st">"data/ct_for_pet_float32.nii.gz"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>nii3ct_float32.set_data_dtype(np.float32)</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="bu">print</span>(nii3ct_float32.get_data_dtype())</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="co">#float32</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>image_data<span class="op">=</span>nii3ct_float32.get_fdata()</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="bu">print</span>(image_data.dtype, image_data.shape)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="co">#float64 (512, 512, 175)</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>plt.imshow(image_data[:,:,<span class="dv">100</span>], cmap<span class="op">=</span><span class="st">"gray"</span>)<span class="op">;</span> plt.show()</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="co">#launch plot window</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>image_data_cropped <span class="op">=</span> image_data[<span class="dv">103</span>:<span class="dv">381</span>,<span class="dv">160</span>:<span class="dv">340</span>,:].copy()</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="co">#x[sagittal], y[coronal], z[axial] #voxel units</span></span></code></pre>
</div>
<div id="accordionSpoiler9" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler9" aria-expanded="false" aria-controls="collapseSpoiler9">
  <h3 class="accordion-header" id="headingSpoiler9">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Notes on copying data
  </h3>
</button>
<div id="collapseSpoiler9" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler9" aria-labelledby="headingSpoiler9">
<div class="accordion-body">
<p>It is important to create a copy of the data (using the copy
function, as show above). Otherwise the new image will reference the
data in the original image, and if you make any changes to the values in
the new image they will also be changed in the original image.</p>
</div>
</div>
</div>
</div>
<p>When creating a new Nifti1Image object you can provide an affine
transform and/or a Nifti1Header object (e.g. nii_1.header). When you
just provide an affine, a default header is created with the sform set
according to the provided affine transform and the qform set to unknown.
When you provide a header, the values in it will be copied into the
header for the new image, except that the dim values will be updated
based on the image data provided. If you provide an affine as well as a
header, and the affine is different to the sform or qform in the header
they will be set to the provided affine and unknown respectively. If the
affine is not provided, it is not set from the header but left empty.
So, if any of your downstream processing will make use of the affine,
make sure you manually set it from the header either when creating the
Nifti1Image object or by calling the set_sform or set_qform functions
for the object (which update the affine as well as setting the
sform/qform). Here we will provide a Nifti1Header object as we want the
header for the new image to based on the uncropped image and will use
the sform from the header as the affine for the new Nifti1Image.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>nii3ct_float32_cropped <span class="op">=</span> nib.nifti1.Nifti1Image(image_data_cropped, nii3ct_float32.get_sform(), nii3ct_float32.header)</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>nii3ct_float32_cropped.shape</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a><span class="co">#(278, 180, 175)</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="bu">print</span>(nii3ct_float32_cropped.header)</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="co">#&lt;class 'nibabel.nifti1.Nifti1Header'&gt; object, endian='&lt;'</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="co">#sizeof_hdr      : 348</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="co">#data_type       : b''</span></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a><span class="co">#db_name         : b''</span></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a><span class="co">#extents         : 0</span></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="co">#session_error   : 0</span></span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a><span class="co">#regular         : b''</span></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a><span class="co">#dim_info        : 0</span></span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a><span class="co">#dim             : [  3 278 180 175   1   1   1   1]</span></span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a><span class="co">#intent_p1       : 0.0</span></span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a><span class="co">#intent_p2       : 0.0</span></span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a><span class="co">#intent_p3       : 0.0</span></span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a><span class="co">#intent_code     : none</span></span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a><span class="co">#datatype        : float32</span></span>
<span id="cb34-16"><a href="#cb34-16" tabindex="-1"></a><span class="co">#bitpix          : 32</span></span>
<span id="cb34-17"><a href="#cb34-17" tabindex="-1"></a><span class="co">#slice_start     : 0</span></span>
<span id="cb34-18"><a href="#cb34-18" tabindex="-1"></a><span class="co">#pixdim          : [-1.         0.9765625  0.9765625  2.         1.         1.</span></span>
<span id="cb34-19"><a href="#cb34-19" tabindex="-1"></a><span class="co">#  1.         1.       ]</span></span>
<span id="cb34-20"><a href="#cb34-20" tabindex="-1"></a><span class="co">#vox_offset      : 0.0</span></span>
<span id="cb34-21"><a href="#cb34-21" tabindex="-1"></a><span class="co">#scl_slope       : nan</span></span>
<span id="cb34-22"><a href="#cb34-22" tabindex="-1"></a><span class="co">#scl_inter       : nan</span></span>
<span id="cb34-23"><a href="#cb34-23" tabindex="-1"></a><span class="co">#slice_end       : 0</span></span>
<span id="cb34-24"><a href="#cb34-24" tabindex="-1"></a><span class="co">#slice_code      : unknown</span></span>
<span id="cb34-25"><a href="#cb34-25" tabindex="-1"></a><span class="co">#xyzt_units      : 2</span></span>
<span id="cb34-26"><a href="#cb34-26" tabindex="-1"></a><span class="co">#cal_max         : 0.0</span></span>
<span id="cb34-27"><a href="#cb34-27" tabindex="-1"></a><span class="co">#cal_min         : 0.0</span></span>
<span id="cb34-28"><a href="#cb34-28" tabindex="-1"></a><span class="co">#slice_duration  : 0.0</span></span>
<span id="cb34-29"><a href="#cb34-29" tabindex="-1"></a><span class="co">#toffset         : 0.0</span></span>
<span id="cb34-30"><a href="#cb34-30" tabindex="-1"></a><span class="co">#glmax           : 0</span></span>
<span id="cb34-31"><a href="#cb34-31" tabindex="-1"></a><span class="co">#glmin           : 0</span></span>
<span id="cb34-32"><a href="#cb34-32" tabindex="-1"></a><span class="co">#descrip         : b''</span></span>
<span id="cb34-33"><a href="#cb34-33" tabindex="-1"></a><span class="co">#aux_file        : b''</span></span>
<span id="cb34-34"><a href="#cb34-34" tabindex="-1"></a><span class="co">#qform_code      : unknown</span></span>
<span id="cb34-35"><a href="#cb34-35" tabindex="-1"></a><span class="co">#sform_code      : aligned</span></span>
<span id="cb34-36"><a href="#cb34-36" tabindex="-1"></a><span class="co">#quatern_b       : 0.0</span></span>
<span id="cb34-37"><a href="#cb34-37" tabindex="-1"></a><span class="co">#quatern_c       : 1.0</span></span>
<span id="cb34-38"><a href="#cb34-38" tabindex="-1"></a><span class="co">#quatern_d       : 0.0</span></span>
<span id="cb34-39"><a href="#cb34-39" tabindex="-1"></a><span class="co">#qoffset_x       : 249.51172</span></span>
<span id="cb34-40"><a href="#cb34-40" tabindex="-1"></a><span class="co">#qoffset_y       : -33.01172</span></span>
<span id="cb34-41"><a href="#cb34-41" tabindex="-1"></a><span class="co">#qoffset_z       : -553.5</span></span>
<span id="cb34-42"><a href="#cb34-42" tabindex="-1"></a><span class="co">#srow_x          : [ -0.9765625   0.          0.        249.51172  ]</span></span>
<span id="cb34-43"><a href="#cb34-43" tabindex="-1"></a><span class="co">#srow_y          : [ -0.          0.9765625   0.        -33.01172  ]</span></span>
<span id="cb34-44"><a href="#cb34-44" tabindex="-1"></a><span class="co">#srow_z          : [   0.    -0.     2.  -553.5]</span></span>
<span id="cb34-45"><a href="#cb34-45" tabindex="-1"></a><span class="co">#intent_name     : b''</span></span>
<span id="cb34-46"><a href="#cb34-46" tabindex="-1"></a><span class="co">#magic           : b'n+1'</span></span></code></pre>
</div>
<p>The cropped image can now be saved using Nibabel’s save function.</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>nib.save(nii3ct_float32_cropped, <span class="st">"data/ct_for_pet_cropped.nii.gz"</span>)</span></code></pre>
</div>
<p>Now load the cropped image into ITK-SNAP. You will see that the image
has been cropped in the x and y dimensions as expected, but it is
shifted relative to the uncropped image:</p>
<figure><img src="../fig/itk-snap_ct_for_pet_cropped_nii_gz.png" alt="Figure. ITK-SNAP: Cropped image in ITK-SNAP" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP: Cropped image in
ITK-SNAP</div>
</figure><p>This is because we did not update the origin/offset in the nifti
header to account for the slices we removed. The origin gives the world
coordinates of the voxel (0, 0, 0). So, if we want the images to remain
aligned, we need to set the origin for the cropped image to be the same
as the world coordinates of voxel (103, 160, 0) in the uncropped image.
This can be calculated using the affine from the uncropped image, and
used to create a new affine matrix with this as the origin (the origin
is the top 3 values in the 4th column of the matrix). The new affine
matrix can then be used to set the sform (which also sets the affine)
for the cropped image, which can then be saved.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>cropped_origin <span class="op">=</span> nii3ct_float32.affine<span class="op">@</span>np.array([<span class="dv">103</span>,<span class="dv">160</span>,<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>cropped_origin</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a><span class="co">#array([ 148.92578125,  123.23828125, -553.5       ,    1.        ])</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>aff_mat_cropped <span class="op">=</span> nii3ct_float32_cropped.get_sform()</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="bu">print</span>(aff_mat_cropped)</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="co">#[[  -0.9765625     0.            0.          249.51171875]</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="co"># [  -0.            0.9765625     0.          -33.01171875]</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="co"># [   0.           -0.            2.         -553.5       ]</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="co"># [   0.            0.            0.            1.        ]]</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>aff_mat_cropped[:, <span class="dv">3</span>] <span class="op">=</span> cropped_origin</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a><span class="bu">print</span>(aff_mat_cropped)</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="co">#[[  -0.9765625     0.            0.          148.92578125]</span></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a><span class="co"># [  -0.            0.9765625     0.          123.23828125]</span></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a><span class="co"># [   0.           -0.            2.         -553.5       ]</span></span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a><span class="co"># [   0.            0.            0.            1.        ]]</span></span></code></pre>
</div>
<p>Note, NiBabel provides handy functionality for slicing nifti images
and updating the affine transforms and header accordingly using the
slicer attribute:</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>nii3ct_float32_cropped.set_sform(aff_mat_cropped)</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>nii3ct_float32_cropped.affine</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a><span class="co">#array([[  -0.9765625 ,    0.        ,    0.        ,  148.92578125],</span></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="co">#       [  -0.        ,    0.9765625 ,    0.        ,  123.23828125],</span></span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a><span class="co">#       [   0.        ,   -0.        ,    2.        , -553.5       ],</span></span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a><span class="co">#       [   0.        ,    0.        ,    0.        ,    1.        ]])</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb40">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>nib.save(nii3ct_float32_cropped, <span class="st">"data/ct_for_pet_float32_cropped_affine.nii.gz"</span>)</span></code></pre>
</div>
<ul>
<li>updating the affine transforms with <code>nibabel.slicer</code>
</li>
</ul>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>nii3ct_float32_cropped_with_nibabel_slicer <span class="op">=</span> nii3ct_float32.slicer[<span class="dv">103</span>:<span class="dv">381</span>,<span class="dv">160</span>:<span class="dv">340</span>,:]</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>nii3ct_float32_cropped_with_nibabel_slicer.affine</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a><span class="co">#array([[  -0.9765625 ,    0.        ,    0.        ,  148.92578125],</span></span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a><span class="co">#       [   0.        ,    0.9765625 ,    0.        ,  123.23828125],</span></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a><span class="co">#       [   0.        ,    0.        ,    2.        , -553.5       ],</span></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a><span class="co">#       [   0.        ,    0.        ,    0.        ,    1.        ]])</span></span></code></pre>
</div>
<p>But you wouldn’t have learnt so much if we’d simply done that to
start with :)</p>
<p>If you load the cropped and aligned image into ITK-SNAP using overlay
semi-transparent feature, you will see that it is now aligned with the
original image but has fewer slices in the x and y dimensions.</p>
<figure><img src="../fig/itk-snap-overlay-semi-transparent-cropped-affine.png" alt="Figure. ITK-SNAP: Cropped image in ITK-SNAP" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP: Cropped image in
ITK-SNAP</div>
</figure><p>If we try to perform a registration between these images as they are,
it will likely have difficulties as the images are so far out of
alignment to start with. One way to roughly align the images prior to
performing a registration is to align the centres of the images by
modifying the origin for the 2nd subject such that the image centres for
both images have the same world coordinates.</p>
<p>This can be done by following these steps:<br>
* Load <code>ct_for_pet_cropped.nii.gz</code><br>
* Calculate the centre of this image in voxel coordinates<br>
* Calculate the centre of this image in world coordinates<br>
* Calculate the centre of the cropped image from subject 1 in voxel
coordinates<br>
* Calculate the centre of the cropped image from subject 1 in world
coordinates<br>
* Calculate the translation (in world coordinates) required to align the
images: Centre image 1 = centre image 2 + translation</p>
<p>Add this translation to the origin for image 2 Save the image for
image 2 using the header with the updated origin Try and write code to
implement these steps yourself, based on what you have learnt so far. If
you get stuck ask me or one of the PGTAs for help.</p>
<p>If you have implemented this correctly when you load the aligned
image from image 2 into ITK-SNAP is should appear roughly aligned with
the images from image 1. You can use <code>Color Map</code> feature tab
and the scroll bar to see the differences between two images.</p>
<figure><img src="../fig/itk-snap-calculating-registrations.png" alt="Figure. ITK-SNAP main window" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP main window</div>
</figure>
</div>
<div class="section level3">
<h3 id="cropped-and-aligned-image">Cropped and aligned image<a class="anchor" aria-label="anchor" href="#cropped-and-aligned-image"></a>
</h3>
<p>Automated image registrations can be prone to be failure if there are
very large initial differences between the images. A manual alignment is
subjective, but can provide a good enough starting guess that keeps the
objective, automated registration more reliable.<br>
* Manually aligning images For manual image registration in ITK-SNAP go
to Tools &gt; image registration</p>
<figure><img src="../fig/itk-snap-image-manual-registration.png" alt="Figure. ITK-SNAP main window" class="figure mx-auto d-block"><div class="figcaption">Figure. ITK-SNAP main window</div>
</figure><ul>
<li>Automatic registration (affine)<br>
You can use <a href="https://nipype.readthedocs.io/en/latest/api/generated/nipype.interfaces.niftyreg.reg.html" class="external-link">niftyreg</a>,
<a href="http://cmictig.cs.ucl.ac.uk/wiki/index.php/Reg_aladin" class="external-link">Reg_aladin</a>
or <a href="https://github.com/Project-MONAI/tutorials/tree/main/3d_registration" class="external-link">DL
methods</a>.</li>
</ul>
</div>
</section><section><h2 class="section-heading" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<hr class="half-width">
<ul>
<li>NiBabel: “The NiBabel documentation also contains some useful
information and tutorials for working with NifTi images and
understanding world coordinate systems and radiological vs neurological
view.”
<ul>
<li>
<a href="https://nipy.org/nibabel/nifti_images.html" class="external-link uri">https://nipy.org/nibabel/nifti_images.html</a><br>
</li>
<li>
<a href="https://nipy.org/nibabel/coordinate_systems.html" class="external-link uri">https://nipy.org/nibabel/coordinate_systems.html</a><br>
</li>
<li>
<a href="https://nipy.org/nibabel/neuro_radio_conventions.html" class="external-link uri">https://nipy.org/nibabel/neuro_radio_conventions.html</a><br>
</li>
</ul>
</li>
<li>ITK-SNAP:
<ul>
<li><a href="http://www.itksnap.org/docs/viewtutorial.php" class="external-link">Tutorial:
Getting Started with ITK-SnAP</a></li>
<li><a href="http://itksnap.org/files/handout_201409.pdf" class="external-link">ITK-SNAP 3.x
Training Class Final Program</a></li>
</ul>
</li>
<li>AI-based medical image registration:
<ul>
<li><a href="https://github.com/Project-MONAI/tutorials/tree/main/2d_registration" class="external-link uri">https://github.com/Project-MONAI/tutorials/tree/main/2d_registration</a></li>
<li><a href="https://github.com/Project-MONAI/tutorials/tree/main/3d_registration" class="external-link uri">https://github.com/Project-MONAI/tutorials/tree/main/3d_registration</a></li>
<li><a href="https://github.com/Project-MONAI/tutorials/tree/main/3d_regression" class="external-link uri">https://github.com/Project-MONAI/tutorials/tree/main/3d_regression</a></li>
</ul>
</li>
</ul>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 --></section></section><section id="aio-excthreesteps"><p>Content from <a href="excthreesteps.html">Demons Image Registration</a></p>
<hr>
<p>Last updated on 2024-09-04 |

        <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/edit/main/episodes/excthreesteps.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 12 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How to understand and visualise three image in one pane for demons
image registration algorithm?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understanding Demons Image Registration code for 3 images viewing
pane</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="demons-image-registration-algorithm-with-multi-pane-display">Demons Image Registration Algorithm with Multi-Pane Display<a class="anchor" aria-label="anchor" href="#demons-image-registration-algorithm-with-multi-pane-display"></a>
</h1>
<div class="section level2">
<h2 id="activate-conda-environment">Activate Conda environment<a class="anchor" aria-label="anchor" href="#activate-conda-environment"></a>
</h2>
<p>Open terminal, activate <code>mirVE</code> environment and run
python</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">conda</span> activate mirVE</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">python</span></span></code></pre>
</div>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  How to avoid ModuleNotFoundError: No module named VARIABLE?
  </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<p>You need to export relative imports, using the following notation for
either linux or windows (might be similar to mac)</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">#WINDOWS</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="bu">set</span> PYTHONPATH=%PYTHONPATH%<span class="kw">;</span><span class="ex">C:\path\to\your\project</span><span class="dt">\</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="ex">#LINUX</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="bu">export</span> <span class="va">PYTHONPATH</span><span class="op">=</span><span class="st">"</span><span class="va">${PYTHONPATH}</span><span class="st">:/path/to/your/project/"</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>This document explains the implementation of a 2D image registration
algorithm using the Demons algorithm. The implementation includes
visualisation updates within a single window containing three panes for
easier comparison of source, target, and warped images.</p>
</div>
<div class="section level2">
<h2 id="importing-libraries">1. Importing Libraries<a class="anchor" aria-label="anchor" href="#importing-libraries"></a>
</h2>
<p>First, we import the necessary libraries for image processing,
transformation, and visualisation. The <code>utils3</code> module is
another Python file containing utility functions used for tasks such as
displaying images and handling deformed and updated fields. Both
<code>demonsReg.py</code> and <code>utils3.py</code> are available in
<code>src/mirc/utils</code></p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>matplotlib.use(<span class="st">'TkAgg'</span>)  <span class="co"># Set the backend for matplotlib</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt  <span class="co"># Import matplotlib for plotting</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np  <span class="co"># Import numpy for numerical operations</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="im">from</span> skimage.transform <span class="im">import</span> rescale, resize  <span class="co"># Import functions for image transformation from scikit-image</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="im">from</span> scipy.ndimage <span class="im">import</span> gaussian_filter  <span class="co"># Import gaussian_filter function from scipy's ndimage module</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="im">from</span> utils3 <span class="im">import</span> dispImage, resampImageWithDefField, calcMSD, dispDefField  <span class="co"># Import specific functions from a custom module</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="function-definition">2. Function Definition<a class="anchor" aria-label="anchor" href="#function-definition"></a>
</h2>
<p>The <code>demonsReg</code> function is designed for registering two
2D images using the Demons algorithm, transforming the source image to
match the target. It offers flexibility through various optional
parameters to customise the registration process:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">def</span> demonsReg(source, target, sigma_elastic<span class="op">=</span><span class="dv">1</span>, sigma_fluid<span class="op">=</span><span class="dv">1</span>, num_lev<span class="op">=</span><span class="dv">3</span>, use_composition<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>              use_target_grad<span class="op">=</span><span class="va">False</span>, max_it<span class="op">=</span><span class="dv">1000</span>, check_MSD<span class="op">=</span><span class="va">True</span>, disp_freq<span class="op">=</span><span class="dv">3</span>, disp_spacing<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>              scale_update_for_display<span class="op">=</span><span class="dv">10</span>, disp_method_df<span class="op">=</span><span class="st">'grid'</span>, disp_method_up<span class="op">=</span><span class="st">'arrows'</span>):</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">    Perform a registration between the 2D source image and the 2D target</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">    image using the demons algorithm. The source image is warped (resampled)</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">    into the space of the target image.</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">    - source: 2D numpy array, the source image to be registered.</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="co">    - target: 2D numpy array, the target image for registration.</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="co">    - sigma_elastic: float, standard deviation for elastic regularisation.</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="co">    - sigma_fluid: float, standard deviation for fluid regularisation.</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="co">    - num_lev: int, number of levels in the multi-resolution scheme.</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="co">    - use_composition: bool, whether to use composition in the update step.</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="co">    - use_target_grad: bool, whether to use the target image gradient.</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="co">    - max_it: int, maximum number of iterations for the registration.</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="co">    - check_MSD: bool, whether to check Mean Squared Difference for improvements.</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="co">    - disp_freq: int, frequency of display updates during registration.</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="co">    - disp_spacing: int, spacing between grid lines or arrows in display.</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="co">    - scale_update_for_display: int, scale factor for displaying the update field.</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="co">    - disp_method_df: str, method for displaying the deformation field ('grid' or 'arrows').</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="co">    - disp_method_up: str, method for displaying the update field ('grid' or 'arrows').</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="co">    - warped_image: 2D numpy array, the source image warped into the target image space.</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a><span class="co">    - def_field: 3D numpy array, the deformation field used to warp the source image.</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="co">    """</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="preparing-images-and-figure-for-demons-image-registration-algorithm">3. Preparing Images and figure for demons image registration
algorithm<a class="anchor" aria-label="anchor" href="#preparing-images-and-figure-for-demons-image-registration-algorithm"></a>
</h2>
<p>We start by making copies of the full-resolution images and
initiating a figure for plotting during registration process.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>    <span class="co"># make copies of full resolution images</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    source_full <span class="op">=</span> source</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    target_full <span class="op">=</span> target</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    <span class="co">#Preparing figure for live update during registration process</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    iteration_text <span class="op">=</span> fig.text(<span class="fl">0.5</span>, <span class="fl">0.92</span>, <span class="st">''</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'black'</span>)</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="multi-resolution-scheme-and-initialisation">4. Multi-Resolution Scheme and Initialisation<a class="anchor" aria-label="anchor" href="#multi-resolution-scheme-and-initialisation"></a>
</h2>
<p>In this step, we initialise variables and set up the multi-resolution
scheme by looping over different resolution levels.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Loop over resolution levels</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="cf">for</span> lev <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, num_lev <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    <span class="co"># Resample images if not at the final level</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="cf">if</span> lev <span class="op">!=</span> num_lev:</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>        resamp_factor <span class="op">=</span> np.power(<span class="dv">2</span>, num_lev <span class="op">-</span> lev)</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>        target <span class="op">=</span> rescale(target_full, <span class="fl">1.0</span> <span class="op">/</span> resamp_factor, mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>, anti_aliasing<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>        source <span class="op">=</span> rescale(source_full, <span class="fl">1.0</span> <span class="op">/</span> resamp_factor, mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>, anti_aliasing<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>        target <span class="op">=</span> target_full</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>        source <span class="op">=</span> source_full</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="deformation-field-initialisation">5. Deformation Field Initialisation<a class="anchor" aria-label="anchor" href="#deformation-field-initialisation"></a>
</h2>
<p>In this step, the code initialises the deformation field and related
variables necessary for the registration process. The deformation field
(def_field) is crucial as it defines the transformation that will be
iteratively adjusted to align the source image with the target image. At
the first resolution level (lev == 1), the initial deformation field is
set up using the grid coordinates derived from the target image
dimensions. Additionally, placeholders for the displacement field
components (disp_field_x and disp_field_y) are created to track
incremental changes in the deformation over iterations.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>    <span class="co"># If first level, initialise deformation and displacement fields</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    <span class="cf">if</span> lev <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>        X, Y <span class="op">=</span> np.mgrid[<span class="dv">0</span>:target.shape[<span class="dv">0</span>], <span class="dv">0</span>:target.shape[<span class="dv">1</span>]]</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>        def_field <span class="op">=</span> np.zeros((X.shape[<span class="dv">0</span>], X.shape[<span class="dv">1</span>], <span class="dv">2</span>))</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> X</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>        def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> Y</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>        disp_field_x <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>        disp_field_y <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>        <span class="co"># Otherwise, upsample displacement field from previous level</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>        disp_field_x <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> resize(disp_field_x, (target.shape[<span class="dv">0</span>], target.shape[<span class="dv">1</span>]), mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>        disp_field_y <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> resize(disp_field_y, (target.shape[<span class="dv">0</span>], target.shape[<span class="dv">1</span>]), mode<span class="op">=</span><span class="st">'edge'</span>, order<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>        <span class="co"># Recalculate deformation field for this level from displacement field</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>        X, Y <span class="op">=</span> np.mgrid[<span class="dv">0</span>:target.shape[<span class="dv">0</span>], <span class="dv">0</span>:target.shape[<span class="dv">1</span>]]</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>        def_field <span class="op">=</span> np.zeros((X.shape[<span class="dv">0</span>], X.shape[<span class="dv">1</span>], <span class="dv">2</span>))  <span class="co"># Clear def_field from previous level</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>        def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> X <span class="op">+</span> disp_field_x</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>        def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> Y <span class="op">+</span> disp_field_y</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="update-initialisation">6. Update Initialisation<a class="anchor" aria-label="anchor" href="#update-initialisation"></a>
</h2>
<p>In this step, the code initialises the update fields and computes the
initial warped image for the current resolution level. These updates are
essential for applying iterative transformations to align the source
image with the target image.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>    <span class="co"># Initialise updates</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    update_x <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    update_y <span class="op">=</span> np.zeros(target.shape)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    update_def_field <span class="op">=</span> np.zeros(def_field.shape)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    </span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    <span class="co"># Calculate the transformed image at the start of this level</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    </span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="co"># Store the current def_field and MSD value to check for improvements at the end of iteration </span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    def_field_prev <span class="op">=</span> def_field.copy()</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>    prev_MSD <span class="op">=</span> calcMSD(target, warped_image)</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    </span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>    <span class="co"># If target image gradient is being used, this can be calculated now as it will not change during the registration</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>    <span class="cf">if</span> use_target_grad:</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>        img_grad_x, img_grad_y <span class="op">=</span> np.gradient(target)</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="initial-transformation-and-preparation">7. Initial Transformation and Preparation<a class="anchor" aria-label="anchor" href="#initial-transformation-and-preparation"></a>
</h2>
<p>In this step, the code performs the initial transformation of the
source image using the current deformation field, calculates and stores
the initial Mean Squared Difference (MSD), and optionally computes the
gradient of the target image. This sets the stage for the iterative
registration process.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># calculate the transformed image at the start of this level</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co"># store the current def_field and MSD value to check for improvements at </span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co"># end of iteration </span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>def_field_prev <span class="op">=</span> def_field.copy()</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>prev_MSD <span class="op">=</span> calcMSD(target, warped_image)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>        </span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co"># if target image gradient is being used this can be calculated now as it will</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co"># not change during the registration</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="cf">if</span> use_target_grad:</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  [img_grad_x, img_grad_y] <span class="op">=</span> np.gradient(target)</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="live-update-of-registration-process">8. Live update of Registration process<a class="anchor" aria-label="anchor" href="#live-update-of-registration-process"></a>
</h2>
<p>Here, we introduce <code>live_update</code> function which works on
updating warped_image, deformation field and update field subplots
during the registration process. This function is used inside the main
iterative loop of the registration process (See next step).</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>  <span class="co"># Function to update the display</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="kw">def</span> live_update():</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>      <span class="co"># Clear the axes</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>      <span class="cf">for</span> ax <span class="kw">in</span> axs:</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>          ax.clear()</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>      <span class="co"># Plotting the warped image in the first subplot</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>      plt.sca(axs[<span class="dv">0</span>])</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>      dispImage(warped_image, title<span class="op">=</span><span class="st">'Warped Image'</span>)</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>      x_lims <span class="op">=</span> plt.xlim()</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>      y_lims <span class="op">=</span> plt.ylim()</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>      <span class="co"># Plotting the deformation field in the second subplot</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>      plt.sca(axs[<span class="dv">1</span>])</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>      dispDefField(def_field, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_df)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>      axs[<span class="dv">1</span>].set_xlim(x_lims)</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>      axs[<span class="dv">1</span>].set_ylim(y_lims)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>      axs[<span class="dv">1</span>].set_title(<span class="st">'Deformation Field'</span>)</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>      <span class="co"># Plotting the updated deformation field in the third subplot</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>      plt.sca(axs[<span class="dv">2</span>])</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>      up_field_to_display <span class="op">=</span> scale_update_for_display <span class="op">*</span> np.dstack((update_x, update_y))</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>      up_field_to_display <span class="op">+=</span> np.dstack((X, Y))</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>      dispDefField(up_field_to_display, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_up)</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>      axs[<span class="dv">2</span>].set_xlim(x_lims)</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>      axs[<span class="dv">2</span>].set_ylim(y_lims)</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>      axs[<span class="dv">2</span>].set_title(<span class="st">'Update Field'</span>)</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>      <span class="co"># Update the iteration text</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>      iteration_text.set_text(<span class="st">'Level </span><span class="sc">{0:d}</span><span class="st">, Iteration </span><span class="sc">{1:d}</span><span class="st">: MSD = </span><span class="sc">{2:.6f}</span><span class="st">'</span>.<span class="bu">format</span>(lev, it, prev_MSD))</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>      </span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>      <span class="co"># Adjust layout for better spacing</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>      plt.tight_layout()</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>      <span class="co"># Redraw the figure</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>      fig.canvas.draw()</span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>      fig.canvas.flush_events()  <span class="co"># Ensure the figure updates immediately</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>      plt.pause(<span class="fl">0.5</span>)</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="main-iterative-loop-for-image-registration">9. Main Iterative Loop for Image Registration<a class="anchor" aria-label="anchor" href="#main-iterative-loop-for-image-registration"></a>
</h2>
<p>In this step, we perform the main iterative loop where the actual
image registration occurs. The loop continues until the maximum number
of iterations is reached or until convergence criteria are met. The loop
updates the deformation field iteratively to minimise the Mean Squared
Difference (MSD) between the target and warped images.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># main iterative loop - repeat until max number of iterations reached</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    <span class="cf">for</span> it <span class="kw">in</span> <span class="bu">range</span>(max_it):</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>      </span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>      <span class="co"># calculate update from demons forces</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>      <span class="co">#</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>      <span class="co"># if the warped image gradient is used (instead of the target image gradient)</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>      <span class="co"># this needs to be calculated </span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>      <span class="cf">if</span> <span class="kw">not</span> use_target_grad:</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>        [img_grad_x, img_grad_y] <span class="op">=</span> np.gradient(warped_image)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>        </span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>      <span class="co"># calculate difference image</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>      diff <span class="op">=</span> target <span class="op">-</span> warped_image</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>      <span class="co"># calculate denominator of demons forces</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>      denom <span class="op">=</span> np.power(img_grad_x, <span class="dv">2</span>) <span class="op">+</span> np.power(img_grad_y, <span class="dv">2</span>) <span class="op">+</span> np.power(diff, <span class="dv">2</span>)</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>      <span class="co"># calculate x and y components of numerator of demons forces</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>      numer_x <span class="op">=</span> diff <span class="op">*</span> img_grad_x</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>      numer_y <span class="op">=</span> diff <span class="op">*</span> img_grad_y</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>      <span class="co"># calculate the x and y components of the update</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>      <span class="co">#denom[denom &lt; 0.01] = np.nan</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>      update_x <span class="op">=</span> numer_x <span class="op">/</span> denom</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>      update_y <span class="op">=</span> numer_y <span class="op">/</span> denom</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>      </span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>      <span class="co"># set nan values to 0</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>      update_x[np.isnan(update_x)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>      update_y[np.isnan(update_y)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>            </span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>      <span class="co"># if fluid like regularisation used smooth the update</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>      <span class="cf">if</span> sigma_fluid <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>        update_x <span class="op">=</span> gaussian_filter(update_x, sigma_fluid, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>        update_y <span class="op">=</span> gaussian_filter(update_y, sigma_fluid, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>      </span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>      <span class="co"># update displacement field using addition (original demons) or</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>      <span class="co"># composition (diffeomorphic demons)</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>      <span class="cf">if</span> use_composition:</span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>        <span class="co"># compose update with current transformation - this is done by</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>        <span class="co"># transforming (resampling) the current transformation using the</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>        <span class="co"># update. we can use the same function as used for resampling</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>        <span class="co"># images, and treat each component of the current deformation</span></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>        <span class="co"># field as an image</span></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>        <span class="co"># the update is a displacement field, but to resample an image</span></span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>        <span class="co"># we need a deformation field, so need to calculate deformation</span></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>        <span class="co"># field corresponding to update.</span></span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a>        update_def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> update_x <span class="op">+</span> X</span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a>        update_def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> update_y <span class="op">+</span> Y</span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>        <span class="co"># use this to resample the current deformation field, storing</span></span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a>        <span class="co"># the result in the same variable, i.e. we overwrite/update the</span></span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a>        <span class="co"># current deformation field with the composed transformation</span></span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a>        def_field <span class="op">=</span> resampImageWithDefField(def_field, update_def_field)</span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a>        <span class="co"># calculate the displacement field from the composed deformation field</span></span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a>        disp_field_x <span class="op">=</span> def_field[:, :, <span class="dv">0</span>] <span class="op">-</span> X</span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>        disp_field_y <span class="op">=</span> def_field[:, :, <span class="dv">1</span>] <span class="op">-</span> Y</span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a>        <span class="co"># replace nans in disp field with 0s</span></span>
<span id="cb11-53"><a href="#cb11-53" tabindex="-1"></a>        disp_field_x[np.isnan(disp_field_x)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-54"><a href="#cb11-54" tabindex="-1"></a>        disp_field_y[np.isnan(disp_field_y)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-55"><a href="#cb11-55" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb11-56"><a href="#cb11-56" tabindex="-1"></a>        <span class="co"># add the update to the current displacement field</span></span>
<span id="cb11-57"><a href="#cb11-57" tabindex="-1"></a>        disp_field_x <span class="op">=</span> disp_field_x <span class="op">+</span> update_x</span>
<span id="cb11-58"><a href="#cb11-58" tabindex="-1"></a>        disp_field_y <span class="op">=</span> disp_field_y <span class="op">+</span> update_y</span>
<span id="cb11-59"><a href="#cb11-59" tabindex="-1"></a>      </span>
<span id="cb11-60"><a href="#cb11-60" tabindex="-1"></a>      </span>
<span id="cb11-61"><a href="#cb11-61" tabindex="-1"></a>      <span class="co"># if elastic like regularisation used smooth the displacement field</span></span>
<span id="cb11-62"><a href="#cb11-62" tabindex="-1"></a>      <span class="cf">if</span> sigma_elastic <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-63"><a href="#cb11-63" tabindex="-1"></a>        disp_field_x <span class="op">=</span> gaussian_filter(disp_field_x, sigma_elastic, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb11-64"><a href="#cb11-64" tabindex="-1"></a>        disp_field_y <span class="op">=</span> gaussian_filter(disp_field_y, sigma_elastic, mode<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb11-65"><a href="#cb11-65" tabindex="-1"></a>      </span>
<span id="cb11-66"><a href="#cb11-66" tabindex="-1"></a>      <span class="co"># update deformation field from disp field</span></span>
<span id="cb11-67"><a href="#cb11-67" tabindex="-1"></a>      def_field[:, :, <span class="dv">0</span>] <span class="op">=</span> disp_field_x <span class="op">+</span> X</span>
<span id="cb11-68"><a href="#cb11-68" tabindex="-1"></a>      def_field[:, :, <span class="dv">1</span>] <span class="op">=</span> disp_field_y <span class="op">+</span> Y</span>
<span id="cb11-69"><a href="#cb11-69" tabindex="-1"></a>            </span>
<span id="cb11-70"><a href="#cb11-70" tabindex="-1"></a>      <span class="co"># transform the image using the updated deformation field</span></span>
<span id="cb11-71"><a href="#cb11-71" tabindex="-1"></a>      warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb11-72"><a href="#cb11-72" tabindex="-1"></a></span>
<span id="cb11-73"><a href="#cb11-73" tabindex="-1"></a>      <span class="co"># update images if required for this iteration</span></span>
<span id="cb11-74"><a href="#cb11-74" tabindex="-1"></a>      <span class="cf">if</span> disp_freq <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> it <span class="op">%</span> disp_freq <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb11-75"><a href="#cb11-75" tabindex="-1"></a>        <span class="co"># Create a single figure with 3 subplots in one row and three columns</span></span>
<span id="cb11-76"><a href="#cb11-76" tabindex="-1"></a>        live_update()</span>
<span id="cb11-77"><a href="#cb11-77" tabindex="-1"></a>      </span>
<span id="cb11-78"><a href="#cb11-78" tabindex="-1"></a>      <span class="co"># calculate MSD between target and warped image</span></span>
<span id="cb11-79"><a href="#cb11-79" tabindex="-1"></a>      MSD <span class="op">=</span> calcMSD(target, warped_image)</span>
<span id="cb11-80"><a href="#cb11-80" tabindex="-1"></a></span>
<span id="cb11-81"><a href="#cb11-81" tabindex="-1"></a>      <span class="co"># display numerical results</span></span>
<span id="cb11-82"><a href="#cb11-82" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">'Level </span><span class="sc">{0:d}</span><span class="st">, Iteration </span><span class="sc">{1:d}</span><span class="st">: MSD = </span><span class="sc">{2:f}</span><span class="ch">\n</span><span class="st">'</span>.<span class="bu">format</span>(lev, it, MSD))</span>
<span id="cb11-83"><a href="#cb11-83" tabindex="-1"></a>      </span>
<span id="cb11-84"><a href="#cb11-84" tabindex="-1"></a>      <span class="co"># check for improvement in MSD if required</span></span>
<span id="cb11-85"><a href="#cb11-85" tabindex="-1"></a>      <span class="cf">if</span> check_MSD <span class="kw">and</span> MSD <span class="op">&gt;=</span> prev_MSD:</span>
<span id="cb11-86"><a href="#cb11-86" tabindex="-1"></a>        <span class="co"># restore previous results and finish level</span></span>
<span id="cb11-87"><a href="#cb11-87" tabindex="-1"></a>        def_field <span class="op">=</span> def_field_prev</span>
<span id="cb11-88"><a href="#cb11-88" tabindex="-1"></a>        warped_image <span class="op">=</span> resampImageWithDefField(source, def_field)</span>
<span id="cb11-89"><a href="#cb11-89" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'No improvement in MSD'</span>)</span>
<span id="cb11-90"><a href="#cb11-90" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb11-91"><a href="#cb11-91" tabindex="-1"></a>      </span>
<span id="cb11-92"><a href="#cb11-92" tabindex="-1"></a>      <span class="co"># update previous values of def_field and MSD</span></span>
<span id="cb11-93"><a href="#cb11-93" tabindex="-1"></a>      def_field_prev <span class="op">=</span> def_field.copy()</span>
<span id="cb11-94"><a href="#cb11-94" tabindex="-1"></a>      prev_MSD <span class="op">=</span> MSD.copy()</span></code></pre>
</div>
<div class="section level3">
<h3 id="results-after-level-1-iterations">9.1. Results after Level 1 iterations:<a class="anchor" aria-label="anchor" href="#results-after-level-1-iterations"></a>
</h3>
<figure><img src="../fig/level1.png" alt="Level 1 Results" class="figure mx-auto d-block"><div class="figcaption">Level 1 Results</div>
</figure>
</div>
<div class="section level3">
<h3 id="results-after-level-2-iterations">9.2. Results after Level 2 iterations:<a class="anchor" aria-label="anchor" href="#results-after-level-2-iterations"></a>
</h3>
<figure><img src="../fig/level2.png" alt="Level 2 Results" class="figure mx-auto d-block"><div class="figcaption">Level 2 Results</div>
</figure>
</div>
<div class="section level3">
<h3 id="results-after-level-3-iterations">9.3. Results after Level 3 iterations:<a class="anchor" aria-label="anchor" href="#results-after-level-3-iterations"></a>
</h3>
<figure><img src="../fig/level3.png" alt="Level 3 Results" class="figure mx-auto d-block"><div class="figcaption">Level 3 Results</div>
</figure>
</div>
</div>
<div class="section level2">
<h2 id="displaying-final-results">11. Displaying Final Results<a class="anchor" aria-label="anchor" href="#displaying-final-results"></a>
</h2>
<p>In this step, we visualise the final results of the image
registration process. This code snippet sets up a visualisation
interface using Matplotlib to display and interact with images and plots
related to image processing tasks. Global variables are initialised to
track the current indices for both images and display modes. Three
images are defined: source, target, and warped_image, along with
corresponding titles stored in image_titles. Two display modes,
‘Deformation Field’ and ‘Jacobian’, are defined in the modes list. The
code defines an event handler function, on_key, which responds to key
presses (‘left’, ‘right’, ‘up’, ‘down’) to navigate between images and
switch display modes. The update_display function clears and updates
three subplots within a single figure based on the current indices and
modes, ensuring the visualisations are refreshed dynamically. Finally, a
Matplotlib figure with subplots is created, initial images and plots are
displayed, and instructions for navigation are added at the bottom. The
figure is connected to the event handler to enable interactive
navigation and mode switching.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="cf">if</span> lev <span class="op">==</span> num_lev:</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  <span class="co"># Initialize global variables for current index tracking</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  current_image_index <span class="op">=</span> [<span class="dv">0</span>]</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  current_mode_index <span class="op">=</span> [<span class="dv">0</span>]</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  </span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  <span class="co"># Define the images and titles</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  images <span class="op">=</span> [source, target, warped_image]</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  image_titles <span class="op">=</span> [<span class="st">'Source Image'</span>, <span class="st">'Target Image'</span>, <span class="st">'Warped Image'</span>]</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>  modes <span class="op">=</span> [<span class="st">'Deformation Field'</span>, <span class="st">'Jacobian'</span>]</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  </span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  </span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  <span class="kw">def</span> on_key(event):</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>      <span class="cf">if</span> event.key <span class="op">==</span> <span class="st">'right'</span>:</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>          current_image_index[<span class="dv">0</span>] <span class="op">=</span> (current_image_index[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="bu">len</span>(images)</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>      <span class="cf">elif</span> event.key <span class="op">==</span> <span class="st">'left'</span>:</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>          current_image_index[<span class="dv">0</span>] <span class="op">=</span> (current_image_index[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">%</span> <span class="bu">len</span>(images)</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>      <span class="cf">elif</span> event.key <span class="op">==</span> <span class="st">'up'</span> <span class="kw">or</span> event.key <span class="op">==</span> <span class="st">'down'</span>:</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>          current_mode_index[<span class="dv">0</span>] <span class="op">=</span> (current_mode_index[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="bu">len</span>(modes)</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>      update_display()</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>  </span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>  <span class="kw">def</span> update_display():</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>      axs_combined[<span class="dv">0</span>].clear()</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>      plt.sca(axs_combined[<span class="dv">0</span>])</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>      dispImage(images[current_image_index[<span class="dv">0</span>]], title<span class="op">=</span>image_titles[current_image_index[<span class="dv">0</span>]])</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>      axs_combined[<span class="dv">1</span>].clear()</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>      plt.sca(axs_combined[<span class="dv">1</span>])</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>      <span class="cf">if</span> modes[current_mode_index[<span class="dv">0</span>]] <span class="op">==</span> <span class="st">'Deformation Field'</span>: </span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>          dispDefField(def_field, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_df)</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>          axs_combined[<span class="dv">1</span>].set_title(<span class="st">'Deformation Field'</span>)</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a>          [jacobian, _] <span class="op">=</span> calcJacobian(def_field)</span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a>          dispImage(jacobian, title<span class="op">=</span><span class="st">'Jacobian'</span>)</span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>          plt.set_cmap(<span class="st">'jet'</span>)</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>          <span class="co">#plt.colorbar()</span></span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>      axs_combined[<span class="dv">2</span>].clear()</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a>      plt.sca(axs_combined[<span class="dv">2</span>])</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a>      diff_image <span class="op">=</span> images[current_image_index[<span class="dv">0</span>]] <span class="op">-</span> target</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>      dispImage(diff_image, title<span class="op">=</span><span class="st">'Difference Image'</span>)</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a>      fig_combined.canvas.draw()</span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a>  <span class="co"># Create a single figure with 3 subplots</span></span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a>  fig_combined, axs_combined <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a></span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a>  <span class="co"># Display initial images</span></span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a>  plt.sca(axs_combined[<span class="dv">0</span>])</span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a>  dispImage(images[current_image_index[<span class="dv">0</span>]], title<span class="op">=</span>image_titles[current_image_index[<span class="dv">0</span>]])</span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a>  plt.sca(axs_combined[<span class="dv">1</span>])</span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>  dispDefField(def_field, spacing<span class="op">=</span>disp_spacing, plot_type<span class="op">=</span>disp_method_df)</span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>  axs_combined[<span class="dv">1</span>].set_title(<span class="st">'Deformation Field'</span>)</span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a></span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a>  plt.sca(axs_combined[<span class="dv">2</span>])</span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a>  diff_image <span class="op">=</span> images[current_image_index[<span class="dv">0</span>]] <span class="op">-</span> target</span>
<span id="cb12-61"><a href="#cb12-61" tabindex="-1"></a>  dispImage(diff_image, title<span class="op">=</span><span class="st">'Difference Image'</span>)</span>
<span id="cb12-62"><a href="#cb12-62" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" tabindex="-1"></a>  <span class="co"># Add instructions for navigating images</span></span>
<span id="cb12-64"><a href="#cb12-64" tabindex="-1"></a>  fig_combined.text(<span class="fl">0.5</span>, <span class="fl">0.02</span>, <span class="st">'Press &lt;- or -&gt; to navigate between source, target and warped images, Press Up or Down to switch between deformation field and Jacobian'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb12-65"><a href="#cb12-65" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" tabindex="-1"></a>  <span class="co"># Connect the key event handler to the figure</span></span>
<span id="cb12-67"><a href="#cb12-67" tabindex="-1"></a>  fig_combined.canvas.mpl_connect(<span class="st">'key_press_event'</span>, on_key)</span>
<span id="cb12-68"><a href="#cb12-68" tabindex="-1"></a></span>
<span id="cb12-69"><a href="#cb12-69" tabindex="-1"></a>  plt.tight_layout()</span>
<span id="cb12-70"><a href="#cb12-70" tabindex="-1"></a>  plt.show()</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="preparing-images-for-calling-the-demonsreg-function">12. Preparing Images for calling the demonsReg function<a class="anchor" aria-label="anchor" href="#preparing-images-for-calling-the-demonsreg-function"></a>
</h2>
<p>Follow <code>exampleSolution3.py</code> available in
<code>src/mirc/example</code> for running the function. Below, we
describe how we prepare images: <code>cine_MR_img_1.png</code>,
<code>cine_MR_img_2.png</code>, and <code>cine_MR_img_3.png</code>.
These images are available in <code>episodes/data</code>.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="im">import</span> skimage.io</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>cine_MR_img_1 <span class="op">=</span> skimage.io.imread(<span class="st">'path/to/your/image/../cine_MR_1.png'</span>) </span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>cine_MR_img_2 <span class="op">=</span> skimage.io.imread(<span class="st">'path/to/your/image/../cine_MR_2.png'</span>)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>cine_MR_img_3 <span class="op">=</span> skimage.io.imread(<span class="st">'path/to/your/image/../cine_MR_3.png'</span>)</span></code></pre>
</div>
<p>Converting all images into double data for standard orientation.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="co"># ***************</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="co"># ADD CODE HERE TO CONVERT ALL THE IMAGES TO DOUBLE DATA TYPE AND TO REORIENTATE THEM</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co"># INTO 'STANDARD ORIENTATION'</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>cine_MR_img_1 <span class="op">=</span> np.double(cine_MR_img_1)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>cine_MR_img_2 <span class="op">=</span> np.double(cine_MR_img_2)</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>cine_MR_img_3 <span class="op">=</span> np.double(cine_MR_img_3)</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>cine_MR_img_1 <span class="op">=</span> np.flip(cine_MR_img_1.T, <span class="dv">1</span>)</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>cine_MR_img_2 <span class="op">=</span> np.flip(cine_MR_img_2.T, <span class="dv">1</span>)</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>cine_MR_img_3 <span class="op">=</span> np.flip(cine_MR_img_3.T, <span class="dv">1</span>)</span></code></pre>
</div>
<div class="section level3">
<h3 id="calling-the-function">Calling the function:<a class="anchor" aria-label="anchor" href="#calling-the-function"></a>
</h3>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>demonsReg(cine_MR_img_1, cine_MR_img_2)</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="final-results-video-navigation-between-images-and-modes">Final Results Video (Navigation between images and modes)<a class="anchor" aria-label="anchor" href="#final-results-video-navigation-between-images-and-modes"></a>
</h3>
<video width="800" height="450" controls><source src="fig/final_results_vid.mp4" type="video/mp4" srcset="NA"><p>Your browser does not support the video tag. </p></source></video><!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</div>
</div></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/" class="external-link">Source</a></p>
				<p><a href="https://github.com/HealthBioscienceIDEAS/Medical-Image-Registration-Short-Course/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.7" class="external-link">sandpaper (0.16.7)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.6" class="external-link">pegboard (0.7.6)</a>, and <a href="https://github.com/HealthBioscienceIDEAS/varnish/tree/IDEAS" class="external-link">varnish (1.0.3.9000)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://HealthBioscienceIDEAS.github.io/Medical-Image-Registration-Short-Course/instructor/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://HealthBioscienceIDEAS.github.io/Medical-Image-Registration-Short-Course/instructor/aio.html",
  "identifier": "https://HealthBioscienceIDEAS.github.io/Medical-Image-Registration-Short-Course/instructor/aio.html",
  "dateCreated": "2024-05-13",
  "dateModified": "2024-09-04",
  "datePublished": "2024-09-04"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

